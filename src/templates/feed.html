{% extends "base.html" %}
{% from "components/link_preview.html" import render_link_preview, render_all_previews %}
{% from "components/post_interactions.html" import reactions_bar %}
{% from "components/reactions_js.html" import reactions_scripts %}
{% from "components/poll.html" import render_poll, poll_voting_js %}

{% block title %}{{ _('Feed') }} - Chronicle{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-2 sm:px-4">
    <div class="flex gap-6 justify-center items-stretch">
    <!-- Main Content -->
    <div id="feed-main" class="w-full max-w-3xl lg:flex-1 lg:max-w-none min-w-0">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <h1 class="font-heading text-2xl font-bold">{{ _('Feed') }}</h1>
        <div class="flex items-center gap-2">
            <!-- View Toggle -->
            <div id="view-toggle" class="flex items-center gap-1 p-1 bg-light-bg dark:bg-dark-bg rounded-lg border border-light-border dark:border-dark-border">
                <button type="button" data-view="list" class="feed-view-btn p-1.5 rounded-md transition-colors text-light-text-secondary dark:text-dark-text-secondary" title="{{ _('List') }}">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                </button>
                <button type="button" data-view="compact" class="feed-view-btn p-1.5 rounded-md transition-colors text-light-text-secondary dark:text-dark-text-secondary" title="{{ _('Compact') }}">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
                </button>
                <button type="button" data-view="cards" class="feed-view-btn p-1.5 rounded-md transition-colors text-light-text-secondary dark:text-dark-text-secondary" title="{{ _('Cards') }}">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/></svg>
                </button>
            </div>
            {% if not current_user.is_authenticated %}
            <a href="{{ url_for('auth.login') }}" class="text-sm text-light-text-muted dark:text-dark-text-muted hover:text-brand-teal transition-colors">
                {{ _('Login') }}
            </a>
            {% endif %}
        </div>
    </div>
    
    <!-- Search & Filters -->
    <div class="mb-6 space-y-3">
        <form id="search-form" class="flex gap-2" method="GET" action="{{ url_for('blog.feed') }}">
            <div class="relative flex-1">
                <input type="text" id="search-input" name="q" value="{{ search_query or '' }}" 
                       class="w-full pl-10 pr-4 py-2 text-sm border border-light-border dark:border-dark-border rounded-lg bg-light-surface dark:bg-dark-surface focus:outline-none focus:ring-2 focus:ring-brand-teal" 
                       placeholder="{{ _('Search') }}...">
                <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-light-text-muted dark:text-dark-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
            </div>
            <button type="button" id="filter-toggle" class="px-3 py-2 text-sm border border-light-border dark:border-dark-border rounded-lg bg-light-surface dark:bg-dark-surface hover:bg-light-bg dark:hover:bg-dark-bg transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>
            </button>
            <button type="submit" class="p-2 sm:px-4 sm:py-2 text-sm font-medium text-white bg-brand-teal rounded-lg hover:opacity-90 transition-opacity" title="{{ _('Search') }}">
                <svg class="w-5 h-5 sm:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <span class="hidden sm:inline">{{ _('Search') }}</span>
            </button>
        </form>
        
        {% if current_user.is_authenticated %}
        <div>
            <a id="mobile-new-post-btn" href="{{ url_for('blog.new_post', next=request.full_path) }}" class="hidden flex w-full items-center justify-center gap-2 px-4 py-3 text-sm font-semibold text-white bg-brand-teal rounded-xl shadow-sm hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-brand-teal focus:ring-offset-2 focus:ring-offset-light-surface dark:focus:ring-offset-dark-surface transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                {{ _('New post') }}
            </a>
        </div>
        {% endif %}
        
        <!-- Advanced Filters (collapsible) -->
        <div id="filter-panel" class="hidden glass-card p-4 space-y-3">
            <div class="grid grid-cols-1 xs:grid-cols-2 md:grid-cols-5 gap-3">
                <!-- Tag Filter -->
                <div>
                    <label class="block text-xs font-medium text-light-text-muted dark:text-dark-text-muted mb-1">{{ _('Tag') }}</label>
                    <input type="hidden" name="tag" id="filter-tag" form="search-form" value="{{ tag_filter or '' }}">
                    <div class="relative">
                        <input type="text" id="tag-search" value="{{ tag_filter or '' }}" autocomplete="off"
                               class="w-full px-2 py-1.5 text-sm border border-light-border dark:border-dark-border rounded-md bg-light-surface dark:bg-dark-surface focus:outline-none focus:ring-1 focus:ring-brand-teal"
                               placeholder="{{ _('Search') }}...">
                        <div id="tag-suggestions" class="hidden absolute z-20 mt-1 w-full max-h-56 overflow-y-auto rounded-md border border-light-border dark:border-dark-border bg-light-surface dark:bg-dark-surface shadow-lg"></div>
                    </div>
                </div>
                
                <!-- Author Filter -->
                <div>
                    <label class="block text-xs font-medium text-light-text-muted dark:text-dark-text-muted mb-1">{{ _('Author') }}</label>
                    <input type="hidden" name="author" id="filter-author" form="search-form" value="{{ author_filter or '' }}">
                    <div class="relative">
                        <input type="text" id="author-search" value="{{ author_filter or '' }}" autocomplete="off"
                               class="w-full px-2 py-1.5 text-sm border border-light-border dark:border-dark-border rounded-md bg-light-surface dark:bg-dark-surface focus:outline-none focus:ring-1 focus:ring-brand-teal"
                               placeholder="{{ _('Search') }}...">
                        <div id="author-suggestions" class="hidden absolute z-20 mt-1 w-full max-h-56 overflow-y-auto rounded-md border border-light-border dark:border-dark-border bg-light-surface dark:bg-dark-surface shadow-lg"></div>
                    </div>
                </div>
                
                <!-- Group Filter -->
                <div>
                    <label class="block text-xs font-medium text-light-text-muted dark:text-dark-text-muted mb-1">{{ _('Group') }}</label>
                    <input type="hidden" name="group" id="filter-group" form="search-form" value="{{ group_filter or '' }}">
                    <div class="relative">
                        <input type="text" id="group-search" value="{{ group_filter or '' }}" autocomplete="off"
                               class="w-full px-2 py-1.5 text-sm border border-light-border dark:border-dark-border rounded-md bg-light-surface dark:bg-dark-surface focus:outline-none focus:ring-1 focus:ring-brand-teal"
                               placeholder="{{ _('Search') }}...">
                        <div id="group-suggestions" class="hidden absolute z-20 mt-1 w-full max-h-56 overflow-y-auto rounded-md border border-light-border dark:border-dark-border bg-light-surface dark:bg-dark-surface shadow-lg"></div>
                    </div>
                </div>
                
                <!-- Date From -->
                <div>
                    <label class="block text-xs font-medium text-light-text-muted dark:text-dark-text-muted mb-1">{{ _('From') }}</label>
                    <input type="date" name="date_from" id="filter-date-from" value="{{ date_from or '' }}" 
                           form="search-form"
                           class="w-full px-2 py-1.5 text-sm border border-light-border dark:border-dark-border rounded-md bg-light-surface dark:bg-dark-surface focus:outline-none focus:ring-1 focus:ring-brand-teal">
                </div>
                
                <!-- Date To -->
                <div>
                    <label class="block text-xs font-medium text-light-text-muted dark:text-dark-text-muted mb-1">{{ _('To') }}</label>
                    <input type="date" name="date_to" id="filter-date-to" value="{{ date_to or '' }}" 
                           form="search-form"
                           class="w-full px-2 py-1.5 text-sm border border-light-border dark:border-dark-border rounded-md bg-light-surface dark:bg-dark-surface focus:outline-none focus:ring-1 focus:ring-brand-teal">
                </div>
            </div>
            <div class="flex justify-end gap-2">
                <a href="{{ url_for('blog.feed') }}" class="px-3 py-1.5 text-sm text-light-text-muted dark:text-dark-text-muted hover:text-brand-teal transition-colors">{{ _('Reset') }}</a>
                <button type="submit" form="search-form" class="px-3 py-1.5 text-sm font-medium text-white bg-brand-teal rounded-md hover:opacity-90 transition-opacity">{{ _('Apply') }}</button>
            </div>
        </div>
        
        <!-- Active Filters Display -->
        {% if search_query or tag_filter or author_filter or group_filter or date_from or date_to %}
        <div class="flex flex-wrap items-center gap-2">
            <span class="text-sm text-light-text-muted dark:text-dark-text-muted">{{ _('Active filters') }}:</span>
            {% if search_query %}
            <span class="inline-flex items-center gap-1 px-2 py-0.5 text-xs bg-light-bg dark:bg-dark-bg rounded-full">
                "{{ search_query }}"
            </span>
            {% endif %}
            {% if tag_filter %}
            <span class="inline-flex items-center gap-1 px-2 py-0.5 text-xs bg-brand-teal/20 text-brand-teal rounded-full">
                #{{ tag_filter }}
            </span>
            {% endif %}
            {% if author_filter %}
            <span class="inline-flex items-center gap-1 px-2 py-0.5 text-xs bg-light-bg dark:bg-dark-bg rounded-full">
                @{{ author_filter }}
            </span>
            {% endif %}
            {% if group_filter %}
            <span class="inline-flex items-center gap-1 px-2 py-0.5 text-xs bg-purple-500/20 text-purple-500 rounded-full">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                {{ group_filter }}
            </span>
            {% endif %}
            {% if date_from or date_to %}
            <span class="inline-flex items-center gap-1 px-2 py-0.5 text-xs bg-light-bg dark:bg-dark-bg rounded-full">
                {{ date_from or '...' }} ‚Äì {{ date_to or '...' }}
            </span>
            {% endif %}
            <a href="{{ url_for('blog.feed') }}" class="text-xs text-brand-teal hover:underline">√ó {{ _('Remove all') }}</a>
        </div>
        {% endif %}
    </div>
    
    {% if posts %}
    <div id="posts-container" class="space-y-6" data-view="list">
        {% for post in posts %}
        {% set is_own_post = current_user.is_authenticated and current_user.id == post.author.id %}
        {% set author_url = url_for('blog.me') if is_own_post else url_for('blog.public_profile', username=post.author.username) %}
        <article class="feed-post glass-card p-4 sm:p-6" data-theme-color="{{ post.author.theme_color or '#4da9a4' }}">
            <!-- Author Header -->
            <div class="flex items-center gap-3 mb-4">
                <a href="{{ author_url }}" class="flex-shrink-0">
                    {% if post.author.avatar_url %}
                    <img src="{{ post.author.avatar_url }}" alt="Avatar" class="w-10 h-10 rounded-full object-cover border-2 hover:opacity-80 transition-opacity" style="border-color: {{ post.author.theme_color or '#4da9a4' }}">
                    {% else %}
                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold text-white hover:opacity-80 transition-opacity" style="background-color: {{ post.author.theme_color or '#4da9a4' }}">
                        {{ (post.author.display_name or post.author.username)[0]|upper }}
                    </div>
                    {% endif %}
                </a>
                <div class="flex-1 min-w-0">
                    <a href="{{ author_url }}" class="font-medium hover:underline">{{ post.author.display_name or post.author.username }}</a>
                    <p class="text-xs text-light-text-muted dark:text-dark-text-muted">
                        <a href="{{ author_url }}" class="hover:underline">@{{ post.author.username }}</a> ¬∑ {{ (post.scheduled_at or post.published_at or post.created_at)|format_dt }}
                        {% if post.updated_at and post.created_at and post.updated_at > post.created_at %} <span class="text-xs text-light-text-muted dark:text-dark-text-muted">({{ _('edited') }})</span>{% endif %}
                        {% if post.page %}
                        ¬∑ <a href="{{ url_for('blog.view_page', slug=post.page.slug) if is_own_post else url_for('blog.public_profile_page', username=post.author.username, slug=post.page.slug) }}" class="hover:underline" style="color: {{ post.author.theme_color or '#4da9a4' }}">{{ post.page.title }}</a>
                        {% endif %}
                    </p>
                </div>
                <div class="flex items-center gap-1 flex-shrink-0">
                    {% if is_own_post %}
                    <a href="{{ url_for('blog.edit_post', post_id=post.id, next=request.full_path) }}" class="p-2 text-light-text-secondary dark:text-dark-text-secondary hover:text-brand-teal rounded-lg hover:bg-light-bg dark:hover:bg-dark-bg transition-colors" title="{{ _('Edit post') }}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-5"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.5 2.5a2.121 2.121 0 113 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                    </a>
                    <form id="delete-post-form-{{ post.id }}" action="{{ url_for('blog.delete_post', post_id=post.id) }}" method="POST" class="inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="next" value="{{ request.full_path }}">
                        <button type="button" onclick="window.confirmModal.show({title: window.I18N.delete_post, message: window.I18N.delete_post_confirm, confirmText: window.I18N.delete, confirmClass: 'bg-red-600 hover:bg-red-700', form: document.getElementById('delete-post-form-{{ post.id }}')})" class="p-2 text-light-text-secondary dark:text-dark-text-secondary hover:text-red-500 rounded-lg hover:bg-light-bg dark:hover:bg-dark-bg transition-colors" title="{{ _('Delete post') }}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </form>
                    {% endif %}
                    {% if post.group %}
                    <a href="{{ url_for('social.group_detail', slug=post.group.slug) }}" class="flex items-center gap-1 px-2 py-1 text-xs rounded-full text-white hover:opacity-90 transition-opacity" style="background-color: {{ post.group.color }}" title="{{ _('Group') }}: {{ post.group.name }}">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        <span class="hidden sm:inline truncate max-w-[100px]">{{ post.group.name }}</span>
                    </a>
                    {% endif %}
                </div>
            </div>
            
            {% if post.title %}
            <h2 class="font-heading text-lg font-bold mb-2">
                {% if search_query %}{{ post.title|highlight(search_query)|safe }}{% else %}{{ post.title }}{% endif %}
            </h2>
            {% endif %}
            
            {% if post.content %}
            <div class="post-content prose dark:prose-invert max-w-none text-light-text-secondary dark:text-dark-text-secondary">
                <div class="post-content-body">
                {% if search_query %}
                {{ post.content|markdown|highlight(search_query)|safe }}
                {% else %}
                {{ post.content|markdown|safe }}
                {% endif %}
                </div>
            </div>
            {% endif %}
            
            {% if post.link_previews.count() > 0 %}
            <div class="link-previews mt-4">
                {{ render_all_previews(post.link_previews) }}
            </div>
            {% endif %}
            
            {{ render_poll(post) }}
            
            {% if post.media_items.all()|length > 0 %}
            <div class="mt-4">
                <div class="image-gallery flex flex-wrap gap-1.5 sm:gap-2 overflow-hidden transition-all duration-300 ease-in-out" style="max-height: 6.5rem;" data-collapsed="true" data-color="{{ post.author.theme_color or '#4da9a4' }}">
                    {% for media in post.media_items.order_by('order').all() %}
                    <div class="group relative">
                        <img src="{{ url_for('static', filename=media.file_path) }}" alt="{{ media.alt_text or _('Image') }}" class="lightbox-image h-24 w-24 sm:h-32 sm:w-32 object-cover rounded-md cursor-pointer hover:opacity-90 transition-opacity">
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            {% if post.tags.all() %}
            <div class="tags-container mt-3 flex flex-wrap gap-1.5">
                {% for tag in post.tags.all() %}
                <a href="{{ url_for('blog.feed', tag=tag.slug) }}" class="text-xs px-2 py-1 rounded-full hover:opacity-80 transition-opacity" style="background-color: {{ tag.color }}20; color: {{ tag.color }}">
                    #{{ tag.name }}
                </a>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Reactions & Comments -->
            {% set is_owner = current_user.is_authenticated and current_user.id == post.user_id %}
            {{ reactions_bar(post, post.author.theme_color, is_owner) }}
            
            <!-- Comments Section (hidden by default) -->
            <div class="comments-section hidden mt-4 pt-4 border-t border-light-border dark:border-dark-border">
                <div class="comments-list space-y-3 mb-4">
                    <p class="text-sm text-light-text-muted dark:text-dark-text-muted">{{ _('Loading comments...') }}</p>
                </div>
                
                {% if current_user.is_authenticated %}
                <form class="comment-form flex gap-2">
                    <input type="text" class="comment-input flex-1 min-w-0 px-3 py-2 text-sm border border-light-border dark:border-dark-border rounded-md bg-light-bg dark:bg-dark-bg focus:outline-none focus:ring-2 focus:ring-brand-teal" placeholder="{{ _('Write a comment...') }}">
                    <button type="submit" class="flex-shrink-0 p-2 sm:px-4 sm:py-2 text-sm font-medium text-white rounded-md transition-colors" title="{{ _('Send') }}">
                        <svg class="w-5 h-5 sm:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                        <span class="hidden sm:inline">{{ _('Send') }}</span>
                    </button>
                </form>
                {% else %}
                <p class="text-sm text-light-text-muted dark:text-dark-text-muted">
                    <a href="{{ url_for('auth.login') }}" class="text-brand-teal hover:underline">{{ _('Login') }}</a>, {{ _('to comment.') }}
                </p>
                {% endif %}
            </div>
        </article>
        {% endfor %}
    </div>
    
    <!-- Infinite Scroll Trigger -->
    {% if has_more %}
    <div id="infinite-scroll-trigger" class="mt-6 py-4" data-page="{{ current_page + 1 }}">
        <div id="loading-indicator" class="hidden">
            <!-- Skeleton Loading -->
            <div class="glass-card p-6 animate-pulse">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 bg-light-border dark:bg-dark-border rounded-full"></div>
                    <div class="flex-1">
                        <div class="h-4 bg-light-border dark:bg-dark-border rounded w-32 mb-2"></div>
                        <div class="h-3 bg-light-border dark:bg-dark-border rounded w-48"></div>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="h-4 bg-light-border dark:bg-dark-border rounded w-full"></div>
                    <div class="h-4 bg-light-border dark:bg-dark-border rounded w-5/6"></div>
                    <div class="h-4 bg-light-border dark:bg-dark-border rounded w-4/6"></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- End of Feed -->
    <div id="end-of-feed" class="hidden mt-6 text-center text-sm text-light-text-muted dark:text-dark-text-muted">
        {{ _('No more posts') }}
    </div>
    {% else %}
    <div class="glass-card p-12 text-center">
        <svg class="w-16 h-16 mx-auto mb-4 text-light-text-muted dark:text-dark-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
        {% if search_query or tag_filter or author_filter or date_from or date_to %}
        <h3 class="font-heading text-lg font-bold mb-2">{{ _('No posts found') }}</h3>
        <p class="text-light-text-muted dark:text-dark-text-muted mb-4">
            {{ _('No posts match the selected filters.') }}{% if date_from or date_to %} ({{ date_from or '...' }} ‚Äì {{ date_to or '...' }}){% endif %}
        </p>
        <a href="{{ url_for('blog.feed') }}" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white rounded-md bg-brand-teal">
            {{ _('Reset filters') }}
        </a>
        {% else %}
        <h3 class="font-heading text-lg font-bold mb-2">{{ _('No posts yet') }}</h3>
        <p class="text-light-text-muted dark:text-dark-text-muted mb-4">{{ _('No posts have been published yet.') }}</p>
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('blog.new_post', next=request.full_path) }}" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white rounded-md bg-brand-teal">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            {{ _('Create first post') }}
        </a>
        {% endif %}
        {% endif %}
    </div>
    {% endif %}
    </div>
    
    <!-- Sidebar -->
    <aside id="feed-sidebar-container" class="hidden lg:block w-72 flex-shrink-0">
        <div id="feed-sidebar" class="sticky top-20 space-y-6">
            {% if current_user.is_authenticated %}
            <!-- Quick Actions -->
            <div class="glass-card p-4">
                <h3 class="font-heading font-bold mb-3">{{ _('Quick actions') }}</h3>
                <div class="space-y-2">
                    <a href="{{ url_for('blog.new_post', next=request.full_path) }}" class="flex items-center gap-2 p-2 rounded-lg hover:bg-light-bg dark:hover:bg-dark-bg transition-colors text-sm">
                        <svg class="w-4 h-4 text-brand-teal" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        {{ _('New post') }}
                    </a>
                    <a href="{{ url_for('blog.me') }}" class="flex items-center gap-2 p-2 rounded-lg hover:bg-light-bg dark:hover:bg-dark-bg transition-colors text-sm">
                        <svg class="w-4 h-4 text-brand-teal" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        {{ _('My Profile') }}
                    </a>
                    <a href="{{ url_for('social.my_bookmarks') }}" class="flex items-center gap-2 p-2 rounded-lg hover:bg-light-bg dark:hover:bg-dark-bg transition-colors text-sm">
                        <svg class="w-4 h-4 text-brand-teal" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
                        {{ _('Bookmarks') }}
                    </a>
                </div>
            </div>
            {% endif %}
            
            <!-- My Groups -->
            <div class="glass-card p-4">
                <h3 class="font-heading font-bold mb-3 flex items-center gap-2">
                    <svg class="w-4 h-4 text-brand-teal" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                    {{ _('My Groups') }}
                </h3>
                {% if user_groups %}
                <div class="space-y-2">
                    {% for group in user_groups[:5] %}
                    <a href="{{ url_for('social.group_detail', slug=group.slug) }}" class="flex items-center gap-2 p-2 rounded-lg hover:bg-light-bg dark:hover:bg-dark-bg transition-colors text-sm group">
                        {% if group.icon_url %}
                        <img src="{{ group.icon_url }}" alt="{{ group.name }}" class="w-6 h-6 rounded object-cover flex-shrink-0">
                        {% else %}
                        <div class="w-6 h-6 rounded flex items-center justify-center text-white text-xs flex-shrink-0" style="background-color: {{ group.color }}">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        </div>
                        {% endif %}
                        <span class="flex-1 min-w-0 truncate">{{ group.name }}</span>
                        <span class="text-xs text-light-text-muted dark:text-dark-text-muted">{{ group.posts.count() }}</span>
                    </a>
                    {% endfor %}
                    {% if user_groups|length > 5 %}
                    <a href="{{ url_for('social.groups_list') }}" class="block text-xs text-brand-teal hover:underline mt-2">{{ _('View all groups') }} ‚Üí</a>
                    {% endif %}
                </div>
                {% else %}
                <p class="text-sm text-light-text-muted dark:text-dark-text-muted mb-3">{{ _('You are not in any group yet.') }}</p>
                {% endif %}
                <a href="{{ url_for('social.groups_list') }}" class="flex items-center gap-2 p-2 rounded-lg hover:bg-light-bg dark:hover:bg-dark-bg transition-colors text-sm text-light-text-secondary dark:text-dark-text-secondary">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
                    {{ _('All groups') }}
                </a>
                <a href="{{ url_for('social.create_group') }}" class="flex items-center gap-2 p-2 rounded-lg hover:bg-light-bg dark:hover:bg-dark-bg transition-colors text-sm text-brand-teal">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    {{ _('New group') }}
                </a>
            </div>

            <!-- Trending Tags -->
            <div class="glass-card p-4">
                <h3 class="font-heading font-bold mb-3 flex items-center gap-2">
                    <svg class="w-4 h-4 text-brand-teal" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/></svg>
                    {{ _('Trending tags') }}
                </h3>
                <div id="trending-tags" class="space-y-2">
                    <div class="animate-pulse space-y-2">
                        <div class="h-6 bg-light-border dark:bg-dark-border rounded w-3/4"></div>
                        <div class="h-6 bg-light-border dark:bg-dark-border rounded w-1/2"></div>
                        <div class="h-6 bg-light-border dark:bg-dark-border rounded w-2/3"></div>
                    </div>
                </div>
            </div>
        </div>
    </aside>
    </div>
</div>

<!-- Post Template for JavaScript -->
<template id="post-template">
    <article class="feed-post glass-card p-4 sm:p-6" data-theme-color="">
        <!-- Author Header -->
        <div class="flex items-center gap-3 mb-4">
            <a class="author-avatar-link flex-shrink-0"></a>
            <div class="flex-1 min-w-0">
                <a class="author-name font-medium hover:underline"></a>
                <p class="author-meta text-xs text-light-text-muted dark:text-dark-text-muted"></p>
            </div>
            <div class="flex items-center gap-1 flex-shrink-0">
                <a class="edit-post-link hidden p-2 text-light-text-secondary dark:text-dark-text-secondary hover:text-brand-teal rounded-lg hover:bg-light-bg dark:hover:bg-dark-bg transition-colors" title="{{ _('Edit post') }}">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-5"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.5 2.5a2.121 2.121 0 113 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                </a>
                <form class="delete-post-form hidden" method="POST">
                    <input type="hidden" name="csrf_token" value="">
                    <input type="hidden" name="next" value="">
                    <button type="button" class="delete-post-btn p-2 text-light-text-secondary dark:text-dark-text-secondary hover:text-red-500 rounded-lg hover:bg-light-bg dark:hover:bg-dark-bg transition-colors" title="{{ _('Delete post') }}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
        
        <div class="post-content prose dark:prose-invert max-w-none text-light-text-secondary dark:text-dark-text-secondary">
            <div class="post-content-body"></div>
        </div>
        
        <div class="link-previews-container mt-4 hidden"></div>
        
        <div class="media-container mt-4 hidden"></div>
        
        <div class="tags-container mt-3 flex flex-wrap gap-1 hidden"></div>
        
        <!-- Reactions -->
        <div class="post-reactions flex flex-wrap items-center gap-2 sm:gap-4 pt-3 border-t border-light-border dark:border-dark-border mt-3 overflow-visible" data-is-owner="false">
            <div class="reactions-summary hidden flex items-center gap-2 text-sm text-light-text-muted dark:text-dark-text-muted"></div>
            <div class="reactions-container relative flex-shrink-0">
                <div class="user-reaction hidden">
                    <button type="button" class="user-reaction-btn p-1 sm:p-1.5 rounded-md bg-light-bg dark:bg-dark-bg transition-all duration-300 text-base sm:text-lg transform hover:scale-110" title="{{ _('Click to change') }}">
                        <span class="user-emoji"></span>
                    </button>
                </div>
                <div class="reaction-options flex items-center gap-0.5 sm:gap-1 transition-all duration-300">
                    <button type="button" class="reaction-btn p-1 sm:p-1.5 rounded-md hover:bg-light-bg dark:hover:bg-dark-bg transition-all duration-200 text-base sm:text-lg hover:scale-110" data-emoji="üëç" title="{{ _('React') }}">üëç</button>
                    <button type="button" class="reaction-btn p-1 sm:p-1.5 rounded-md hover:bg-light-bg dark:hover:bg-dark-bg transition-all duration-200 text-base sm:text-lg hover:scale-110" data-emoji="‚ù§Ô∏è" title="{{ _('React') }}">‚ù§Ô∏è</button>
                    <button type="button" class="reaction-btn p-1 sm:p-1.5 rounded-md hover:bg-light-bg dark:hover:bg-dark-bg transition-all duration-200 text-base sm:text-lg hover:scale-110" data-emoji="üòÇ" title="{{ _('React') }}">üòÇ</button>
                    <button type="button" class="reaction-btn p-1 sm:p-1.5 rounded-md hover:bg-light-bg dark:hover:bg-dark-bg transition-all duration-200 text-base sm:text-lg hover:scale-110" data-emoji="üòÆ" title="{{ _('React') }}">üòÆ</button>
                    <button type="button" class="reaction-btn p-1 sm:p-1.5 rounded-md hover:bg-light-bg dark:hover:bg-dark-bg transition-all duration-200 text-base sm:text-lg hover:scale-110" data-emoji="üò¢" title="{{ _('React') }}">üò¢</button>
                    <button type="button" class="reaction-btn p-1 sm:p-1.5 rounded-md hover:bg-light-bg dark:hover:bg-dark-bg transition-all duration-200 text-base sm:text-lg hover:scale-110" data-emoji="üéâ" title="{{ _('React') }}">üéâ</button>
                </div>
            </div>
            <div class="reactions-display flex items-center gap-1 text-sm flex-shrink-0"></div>
            <div class="flex-1 min-w-0"></div>
            <div class="flex items-center gap-1 flex-shrink-0">
                <button type="button" class="bookmark-btn p-1.5 rounded-md hover:bg-light-bg dark:hover:bg-dark-bg transition-colors" title="{{ _('Bookmark') }}">
                    <svg class="w-5 h-5 bookmark-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
                </button>
                <button type="button" class="comment-toggle-btn p-1.5 rounded-md hover:bg-light-bg dark:hover:bg-dark-bg transition-colors flex items-center gap-1" title="{{ _('Comments') }}">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                    <span class="comment-count text-xs text-light-text-muted dark:text-dark-text-muted">0</span>
                </button>
            </div>
        </div>
        
        <!-- Comments Section -->
        <div class="comments-section hidden mt-4 pt-4 border-t border-light-border dark:border-dark-border">
            <div class="comments-list space-y-3 mb-4"></div>
            <form class="comment-form flex gap-2">
                <input type="text" class="comment-input flex-1 min-w-0 px-3 py-2 text-sm border border-light-border dark:border-dark-border rounded-md bg-light-bg dark:bg-dark-bg focus:outline-none focus:ring-2 focus:ring-brand-teal" placeholder="{{ _('Write a comment...') }}">
                <button type="submit" class="comment-submit-btn flex-shrink-0 p-2 sm:px-4 sm:py-2 text-sm font-medium text-white rounded-md transition-colors" title="{{ _('Send') }}">
                    <svg class="w-5 h-5 sm:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                    <span class="hidden sm:inline">{{ _('Send') }}</span>
                </button>
            </form>
        </div>
    </article>
</template>
{% endblock %}

{% block scripts %}
{{ reactions_scripts('#4da9a4', current_user.id if current_user.is_authenticated else None) }}
<script>
    // Image gallery expand/collapse - run after images load
    function initImageGalleries() {
        document.querySelectorAll('.image-gallery').forEach(function(gallery) {
            // Skip if already initialized
            if (gallery.dataset.initialized === 'true') return;
            
            const totalImages = gallery.querySelectorAll('.group').length;
            
            // Only show expand button if more than 3 images
            if (totalImages <= 3) return;
            
            const isMobile = window.innerWidth < 640;
            const imageSize = isMobile ? 102 : 136; // h-24 + gap vs h-32 + gap
            const containerWidth = gallery.offsetWidth || 300;
            const imagesPerRow = Math.max(1, Math.floor(containerWidth / imageSize));
            const hiddenCount = totalImages - imagesPerRow;
            
            if (hiddenCount <= 0) return;
            
            gallery.dataset.initialized = 'true';
            
            const color = gallery.dataset.color || '#4da9a4';
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'gallery-expand-btn mt-2 text-sm font-medium transition-colors flex items-center gap-1';
            btn.style.color = color;
            btn.innerHTML = `<span class="expand-text">${window.I18N.show_more} (${hiddenCount} ${window.I18N.more})</span><svg class="w-4 h-4 expand-icon transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>`;
            
            const moreText = `${window.I18N.show_more} (${hiddenCount} ${window.I18N.more})`;
            gallery.parentNode.appendChild(btn);
            
            btn.addEventListener('click', function() {
                const isCollapsed = gallery.dataset.collapsed === 'true';
                const textSpan = btn.querySelector('.expand-text');
                const icon = btn.querySelector('.expand-icon');
                
                if (isCollapsed) {
                    gallery.style.maxHeight = 'none';
                    gallery.dataset.collapsed = 'false';
                    textSpan.textContent = window.I18N.show_less;
                    icon.style.transform = 'rotate(180deg)';
                } else {
                    gallery.style.maxHeight = window.innerWidth < 640 ? '6.5rem' : '8.5rem';
                    gallery.dataset.collapsed = 'true';
                    textSpan.textContent = moreText;
                    icon.style.transform = 'rotate(0deg)';
                }
            });
        });
    }
    
    // Run on DOMContentLoaded and after a short delay to ensure images are loaded
    document.addEventListener('DOMContentLoaded', function() {
        initImageGalleries();
        // Re-run after images might have loaded
        setTimeout(initImageGalleries, 500);
        
        // YouTube click-to-play - open in new tab
        document.querySelectorAll('.youtube-preview').forEach(function(preview) {
            preview.addEventListener('click', function() {
                const videoId = this.dataset.videoId;
                window.open('https://www.youtube.com/watch?v=' + videoId, '_blank');
            });
        });
    });
    
    // Create post element from template
    function createPostElement(post) {
        const template = document.getElementById('post-template');
        const article = template.content.cloneNode(true).querySelector('article');

        // Accent color for dynamic UI bits (e.g., collapse toggle)
        article.dataset.themeColor = post.author.theme_color || '#4da9a4';
        
        // Set post ID
        article.querySelector('.post-reactions').dataset.postId = post.id;
        
        const isDeletedAuthor = !!(post.author && post.author.is_deleted);
        // Profile URL - use /me for own posts
        const profileUrl = isDeletedAuthor ? null : (post.is_owner ? '/me' : '/u/' + post.author.username);
        
        // Author avatar with link
        const avatarLink = article.querySelector('.author-avatar-link');
        if (profileUrl) {
            avatarLink.href = profileUrl;
            avatarLink.classList.remove('pointer-events-none');
            avatarLink.removeAttribute('aria-disabled');
        } else {
            avatarLink.href = '#';
            avatarLink.classList.add('pointer-events-none');
            avatarLink.setAttribute('aria-disabled', 'true');
        }
        if (post.author.avatar_url) {
            avatarLink.innerHTML = `<img src="${post.author.avatar_url}" alt="Avatar" class="w-10 h-10 rounded-full object-cover border-2 hover:opacity-80 transition-opacity" style="border-color: ${post.author.theme_color}">`;
        } else {
            const initial = isDeletedAuthor ? (window.I18N.deleted_user || 'D')[0].toUpperCase() : (post.author.display_name || post.author.username || '?')[0].toUpperCase();
            avatarLink.innerHTML = `<div class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold text-white hover:opacity-80 transition-opacity" style="background-color: ${post.author.theme_color || '#6b7280'}">${initial}</div>`;
        }
        
        // Author name with link
        const authorName = article.querySelector('.author-name');
        if (profileUrl) {
            authorName.href = profileUrl;
            authorName.classList.remove('pointer-events-none');
            authorName.removeAttribute('aria-disabled');
            authorName.textContent = post.author.display_name || post.author.username;
        } else {
            authorName.href = '#';
            authorName.classList.add('pointer-events-none');
            authorName.setAttribute('aria-disabled', 'true');
            authorName.textContent = window.I18N.deleted_user;
        }
        
        // Author meta with link
        const editedBadge = post.is_edited ? ` <span class="text-xs text-light-text-muted dark:text-dark-text-muted">(${window.I18N.edited})</span>` : '';
        if (profileUrl) {
            article.querySelector('.author-meta').innerHTML = `<a href="${profileUrl}" class="hover:underline">@${post.author.username}</a> ¬∑ ${post.created_at}${editedBadge}`;
        } else {
            article.querySelector('.author-meta').innerHTML = `${window.I18N.deleted_user} ¬∑ ${post.created_at}${editedBadge}`;
        }
        
        const currentNext = window.location.pathname + window.location.search;

        // Edit link (only for owner)
        const editLink = article.querySelector('.edit-post-link');
        if (editLink) {
            if (post.is_owner) {
                editLink.href = '/me/posts/' + post.id + '/edit?next=' + encodeURIComponent(currentNext);
                editLink.classList.remove('hidden');
            } else {
                editLink.classList.add('hidden');
            }
        }

        // Delete (only for owner)
        const deleteForm = article.querySelector('.delete-post-form');
        const deleteBtn = article.querySelector('.delete-post-btn');
        if (deleteForm && deleteBtn) {
            if (post.is_owner) {
                deleteForm.action = '/me/posts/' + post.id + '/delete';
                const csrfInput = deleteForm.querySelector('input[name="csrf_token"]');
                const nextInput = deleteForm.querySelector('input[name="next"]');
                if (csrfInput) csrfInput.value = (window.csrfToken || '');
                if (nextInput) nextInput.value = currentNext;
                deleteForm.classList.remove('hidden');
                deleteBtn.addEventListener('click', function() {
                    window.confirmModal.show({
                        title: window.I18N.delete_post,
                        message: window.I18N.delete_post_confirm,
                        confirmText: window.I18N.delete,
                        confirmClass: 'bg-red-600 hover:bg-red-700',
                        form: deleteForm
                    });
                });
            } else {
                deleteForm.classList.add('hidden');
            }
        }
        
        // Content
        const postContentBody = article.querySelector('.post-content-body');
        if (postContentBody) {
            postContentBody.innerHTML = post.content_html;
        }
        
        // Link Previews
        if (post.link_previews && post.link_previews.length > 0) {
            const previewsContainer = article.querySelector('.link-previews-container');
            previewsContainer.classList.remove('hidden');
            let previewsHtml = '';
            post.link_previews.forEach(preview => {
                if (preview.embed_type === 'youtube') {
                    previewsHtml += `
                        <div class="youtube-preview my-4 relative aspect-video rounded-lg overflow-hidden shadow-md cursor-pointer group" data-video-id="${preview.embed_id}">
                            <img src="https://img.youtube.com/vi/${preview.embed_id}/maxresdefault.jpg" 
                                 alt="${preview.title || 'YouTube Video'}" 
                                 class="w-full h-full object-cover"
                                 onerror="this.src='https://img.youtube.com/vi/${preview.embed_id}/hqdefault.jpg'">
                            <div class="absolute inset-0 bg-black/30 group-hover:bg-black/40 transition-colors flex items-center justify-center">
                                <div class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform shadow-lg">
                                    <svg class="w-8 h-8 text-white ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                </div>
                            </div>
                            ${preview.title ? `<div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-3">
                                <p class="text-white text-sm font-medium line-clamp-2">${preview.title}</p>
                                <p class="text-white/70 text-xs mt-1">YouTube</p>
                            </div>` : ''}
                        </div>`;
                } else if (preview.embed_type === 'link' && (preview.title || preview.description)) {
                    previewsHtml += `
                        <a href="${preview.url}" target="_blank" rel="noopener noreferrer" class="block my-4 no-underline group">
                            <div class="flex bg-light-bg dark:bg-dark-bg border border-light-border dark:border-dark-border rounded-lg overflow-hidden hover:border-brand-teal transition-colors">
                                ${preview.image_url ? `<div class="flex-shrink-0 w-32 h-32 md:w-40 md:h-28">
                                    <img src="${preview.image_url}" alt="" class="w-full h-full object-cover" loading="lazy" onerror="this.parentElement.style.display='none'">
                                </div>` : ''}
                                <div class="flex-1 p-3 min-w-0">
                                    ${preview.site_name ? `<p class="text-xs text-light-text-muted dark:text-dark-text-muted uppercase tracking-wide mb-1">${preview.site_name}</p>` : ''}
                                    ${preview.title ? `<h4 class="font-medium text-light-text-primary dark:text-dark-text-primary group-hover:text-brand-teal transition-colors line-clamp-2 mb-1">${preview.title}</h4>` : ''}
                                    ${preview.description ? `<p class="text-sm text-light-text-secondary dark:text-dark-text-secondary line-clamp-2">${preview.description}</p>` : ''}
                                </div>
                            </div>
                        </a>`;
                }
            });
            previewsContainer.innerHTML = previewsHtml;
            
            // Add click handlers for YouTube previews
            previewsContainer.querySelectorAll('.youtube-preview').forEach(preview => {
                preview.addEventListener('click', function() {
                    const videoId = this.dataset.videoId;
                    window.open('https://www.youtube.com/watch?v=' + videoId, '_blank');
                });
            });
        }
        
        // Media
        if (post.media && post.media.length > 0) {
            const mediaContainer = article.querySelector('.media-container');
            mediaContainer.classList.remove('hidden');
            const isMobile = window.innerWidth < 640;
            let galleryHtml = `<div class="image-gallery flex flex-wrap gap-1.5 sm:gap-2 overflow-hidden" style="max-height: ${isMobile ? '7rem' : '8.5rem'};" data-collapsed="true" data-color="${post.author.theme_color}">`;
            post.media.forEach(m => {
                galleryHtml += `<div class="group relative"><img src="/static/${m.url}" alt="${window.I18N.image}" class="lightbox-image h-24 w-24 sm:h-32 sm:w-32 object-cover rounded-md cursor-pointer"></div>`;
            });
            galleryHtml += '</div>';
            mediaContainer.innerHTML = galleryHtml;
        }
        
        // Tags
        if (post.tags && post.tags.length > 0) {
            const tagsContainer = article.querySelector('.tags-container');
            tagsContainer.classList.remove('hidden');
            post.tags.forEach(tag => {
                const a = document.createElement('a');
                a.href = '/feed?tag=' + encodeURIComponent(tag.slug);
                a.className = 'text-xs px-2 py-1 rounded-full hover:opacity-80 transition-opacity';
                const c = tag.color || '#4da9a4';
                a.style.backgroundColor = c + '20';
                a.style.color = c;
                a.textContent = '#' + tag.name;
                tagsContainer.appendChild(a);
            });
        }
        
        // Theme color for submit button
        article.querySelector('.comment-submit-btn').style.backgroundColor = post.author.theme_color;
        
        // Hide reaction options for own posts
        if (post.is_owner) {
            const reactionOptions = article.querySelector('.reaction-options');
            if (reactionOptions) {
                reactionOptions.classList.add('hidden');
            }
            article.querySelector('.post-reactions').dataset.isOwner = 'true';
        }
        
        return article;
    }
    
    // Global function for loading more posts (called via Intersection Observer)
    let isLoading = false;
    let hasMore = {{ 'true' if has_more else 'false' }};
    const postsContainer = document.getElementById('posts-container');
    const mobileNewPostBtn = document.getElementById('mobile-new-post-btn');
    const sidebarContainer = document.getElementById('feed-sidebar-container');

    if (mobileNewPostBtn) {
        const updateMobileButtonVisibility = () => {
            const sidebarVisible = sidebarContainer && window.getComputedStyle(sidebarContainer).display !== 'none';
            if (sidebarVisible) {
                mobileNewPostBtn.classList.add('hidden');
            } else {
                mobileNewPostBtn.classList.remove('hidden');
            }
        };

        updateMobileButtonVisibility();
        window.addEventListener('resize', updateMobileButtonVisibility);
        window.addEventListener('orientationchange', updateMobileButtonVisibility);
    }
    
    function loadMorePosts() {
        if (isLoading || !hasMore) return;
        
        const trigger = document.getElementById('infinite-scroll-trigger');
        if (!trigger) return;
        
        const loadingIndicator = document.getElementById('loading-indicator');
        const nextPage = parseInt(trigger.dataset.page);
        
        isLoading = true;
        loadingIndicator.classList.remove('hidden');
        
        const searchQuery = '{{ search_query or "" }}';

        const params = new URLSearchParams(window.location.search);
        params.set('page', String(nextPage));
        if (searchQuery) params.set('q', searchQuery);

        fetch('/feed/api?' + params.toString())
            .then(res => res.json())
            .then(data => {
                const posts = (data && data.posts) ? data.posts : [];
                posts.forEach(p => {
                    const el = createPostElement(p);
                    postsContainer.appendChild(el);
                });

                hasMore = !!(data && data.has_more);
                if (hasMore) {
                    trigger.dataset.page = String((data && data.page ? data.page : nextPage) + 1);
                } else {
                    trigger.classList.add('hidden');
                    const endOfFeed = document.getElementById('end-of-feed');
                    if (endOfFeed) endOfFeed.classList.remove('hidden');
                }
            })
            .catch(() => {
                // keep silent; loading indicator will be hidden below
            })
            .finally(() => {
                isLoading = false;
                loadingIndicator.classList.add('hidden');
            });
    }

    // Intersection Observer for infinite scroll
    const scrollTrigger = document.getElementById('infinite-scroll-trigger');
    if (scrollTrigger) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    loadMorePosts();
                }
            });
        }, { rootMargin: '200px' });

        observer.observe(scrollTrigger);
    }

    // Filter panel toggle
    document.getElementById('filter-toggle').addEventListener('click', function() {
        const panel = document.getElementById('filter-panel');
        panel.classList.toggle('hidden');
    });
    
    // Show filter panel if filters are active
    {% if tag_filter or author_filter or group_filter or date_from or date_to %}
    document.getElementById('filter-panel').classList.remove('hidden');
    {% endif %}

    const authorSearch = document.getElementById('author-search');
    const authorHidden = document.getElementById('filter-author');
    const authorSuggestions = document.getElementById('author-suggestions');
    let authorSearchTimeout = null;

    const tagSearch = document.getElementById('tag-search');
    const tagHidden = document.getElementById('filter-tag');
    const tagSuggestions = document.getElementById('tag-suggestions');
    let tagSearchTimeout = null;

    function closeTagSuggestions() {
        tagSuggestions.classList.add('hidden');
        tagSuggestions.innerHTML = '';
    }

    function renderTagSuggestions(tags) {
        if (!tags || tags.length === 0) {
            closeTagSuggestions();
            return;
        }
        tagSuggestions.innerHTML = tags.map(t => `
            <button type="button" class="w-full text-left px-3 py-2 text-sm hover:bg-light-bg dark:hover:bg-dark-bg transition-colors">
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full" style="background-color: ${t.color || '#4da9a4'}"></span>
                    <div class="font-medium truncate">#${t.name}</div>
                </div>
                <div class="text-xs text-light-text-muted dark:text-dark-text-muted">${t.slug}</div>
            </button>
        `).join('');

        Array.from(tagSuggestions.querySelectorAll('button')).forEach((btn, idx) => {
            btn.addEventListener('click', () => {
                const t = tags[idx];
                tagHidden.value = t.slug;
                tagSearch.value = '#' + t.name;
                closeTagSuggestions();
            });
        });
        tagSuggestions.classList.remove('hidden');
    }

    function searchTags(q) {
        fetch('/api/tags/search?q=' + encodeURIComponent(q))
            .then(res => res.json())
            .then(data => renderTagSuggestions(data.tags || []))
            .catch(() => closeTagSuggestions());
    }

    if (tagSearch) {
        tagSearch.addEventListener('input', function() {
            const raw = this.value.trim();
            const q = raw.startsWith('#') ? raw.slice(1) : raw;

            clearTimeout(tagSearchTimeout);
            tagSearchTimeout = setTimeout(() => {
                if (!q) {
                    tagHidden.value = '';
                    closeTagSuggestions();
                    return;
                }
                tagHidden.value = '';
                searchTags(q);
            }, 150);
        });

        tagSearch.addEventListener('focus', function() {
            const raw = this.value.trim();
            const q = raw.startsWith('#') ? raw.slice(1) : raw;
            if (q && tagHidden.value === '') {
                searchTags(q);
            }
        });

        tagSearch.addEventListener('blur', function() {
            setTimeout(closeTagSuggestions, 150);
        });
    }

    function closeAuthorSuggestions() {
        authorSuggestions.classList.add('hidden');
        authorSuggestions.innerHTML = '';
    }

    function renderAuthorSuggestions(users) {
        if (!users || users.length === 0) {
            closeAuthorSuggestions();
            return;
        }
        authorSuggestions.innerHTML = users.map(u => `
            <button type="button" class="w-full text-left px-3 py-2 text-sm hover:bg-light-bg dark:hover:bg-dark-bg transition-colors">
                <div class="font-medium truncate">${u.display_name || u.username}</div>
                <div class="text-xs text-light-text-muted dark:text-dark-text-muted">@${u.username}</div>
            </button>
        `).join('');

        Array.from(authorSuggestions.querySelectorAll('button')).forEach((btn, idx) => {
            btn.addEventListener('click', () => {
                const u = users[idx];
                authorHidden.value = u.username;
                authorSearch.value = u.display_name ? `${u.display_name} (@${u.username})` : `@${u.username}`;
                closeAuthorSuggestions();
            });
        });
        authorSuggestions.classList.remove('hidden');
    }

    function searchAuthors(q) {
        fetch('/api/users/search?q=' + encodeURIComponent(q))
            .then(res => res.json())
            .then(data => renderAuthorSuggestions(data.users || []))
            .catch(() => closeAuthorSuggestions());
    }

    if (authorSearch) {
        authorSearch.addEventListener('input', function() {
            const raw = this.value.trim();
            const q = raw.startsWith('@') ? raw.slice(1) : raw;

            clearTimeout(authorSearchTimeout);
            authorSearchTimeout = setTimeout(() => {
                if (!q) {
                    authorHidden.value = '';
                    closeAuthorSuggestions();
                    return;
                }
                authorHidden.value = '';
                searchAuthors(q);
            }, 150);
        });

        authorSearch.addEventListener('focus', function() {
            const raw = this.value.trim();
            const q = raw.startsWith('@') ? raw.slice(1) : raw;
            if (q && authorHidden.value === '') {
                searchAuthors(q);
            }
        });

        authorSearch.addEventListener('blur', function() {
            setTimeout(closeAuthorSuggestions, 150);
        });
    }

    const searchForm = document.getElementById('search-form');
    if (searchForm && authorSearch && authorHidden) {
        searchForm.addEventListener('submit', function() {
            if (authorHidden.value) return;

            const raw = (authorSearch.value || '').trim();
            if (!raw) return;

            const mentionMatch = raw.match(/@([a-zA-Z0-9_]{1,30})/);
            if (mentionMatch) {
                authorHidden.value = mentionMatch[1];
                return;
            }

            const simpleUsernameMatch = raw.match(/^([a-zA-Z0-9_]{1,30})$/);
            if (simpleUsernameMatch) {
                authorHidden.value = simpleUsernameMatch[1];
            }
        });
    }

    if (searchForm && tagSearch && tagHidden) {
        searchForm.addEventListener('submit', function() {
            if (tagHidden.value) return;

            const raw = (tagSearch.value || '').trim();
            if (!raw) return;

            const tagMatch = raw.match(/#?([a-zA-Z0-9_-]{1,50})/);
            if (tagMatch) {
                tagHidden.value = tagMatch[1];
            }
        });
    }

    // Group filter live search
    const groupSearch = document.getElementById('group-search');
    const groupHidden = document.getElementById('filter-group');
    const groupSuggestions = document.getElementById('group-suggestions');
    let groupSearchTimeout = null;

    function closeGroupSuggestions() {
        if (groupSuggestions) {
            groupSuggestions.classList.add('hidden');
            groupSuggestions.innerHTML = '';
        }
    }

    function renderGroupSuggestions(groups) {
        if (!groups || groups.length === 0) {
            closeGroupSuggestions();
            return;
        }
        groupSuggestions.innerHTML = groups.map(g => `
            <button type="button" class="w-full text-left px-3 py-2 text-sm hover:bg-light-bg dark:hover:bg-dark-bg transition-colors">
                <div class="flex items-center gap-2">
                    <span class="w-4 h-4 rounded flex items-center justify-center" style="background-color: ${g.color}">
                        <svg class="w-2.5 h-2.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    </span>
                    <div class="font-medium truncate">${g.name}</div>
                </div>
            </button>
        `).join('');

        Array.from(groupSuggestions.querySelectorAll('button')).forEach((btn, idx) => {
            btn.addEventListener('click', () => {
                const g = groups[idx];
                groupHidden.value = g.slug;
                groupSearch.value = g.name;
                closeGroupSuggestions();
            });
        });
        groupSuggestions.classList.remove('hidden');
    }

    function searchGroups(q) {
        fetch('/api/groups/search?q=' + encodeURIComponent(q))
            .then(res => res.json())
            .then(data => renderGroupSuggestions(data.groups || []))
            .catch(() => closeGroupSuggestions());
    }

    if (groupSearch) {
        groupSearch.addEventListener('input', function() {
            const q = this.value.trim();

            clearTimeout(groupSearchTimeout);
            groupSearchTimeout = setTimeout(() => {
                if (!q) {
                    groupHidden.value = '';
                    closeGroupSuggestions();
                    return;
                }
                groupHidden.value = '';
                searchGroups(q);
            }, 150);
        });

        groupSearch.addEventListener('focus', function() {
            const q = this.value.trim();
            if (q && groupHidden.value === '') {
                searchGroups(q);
            }
        });

        groupSearch.addEventListener('blur', function() {
            setTimeout(closeGroupSuggestions, 150);
        });
    }

    if (searchForm && groupSearch && groupHidden) {
        searchForm.addEventListener('submit', function() {
            if (groupHidden.value) return;

            const raw = (groupSearch.value || '').trim();
            if (!raw) return;

            // Use the typed value as-is for group slug
            groupHidden.value = raw.toLowerCase().replace(/\s+/g, '-');
        });
    }
    
    // Load trending tags
    fetch('/api/tags/trending')
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById('trending-tags');
            if (!container) return;
            if (data.tags.length === 0) {
                container.innerHTML = `<p class="text-sm text-light-text-muted dark:text-dark-text-muted">${window.I18N.no_trending_tags}</p>`;
                return;
            }
            
            container.innerHTML = data.tags.map(tag => `
                <a href="/feed?tag=${tag.slug}" class="flex items-center justify-between p-2 rounded-lg hover:bg-light-bg dark:hover:bg-dark-bg transition-colors group">
                    <span class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full" style="background-color: ${tag.color}"></span>
                        <span class="text-sm font-medium group-hover:text-brand-teal transition-colors">#${tag.name}</span>
                    </span>
                    <span class="text-xs text-light-text-muted dark:text-dark-text-muted">${tag.post_count}</span>
                </a>
            `).join('');
        })
        .catch(() => {
            document.getElementById('trending-tags').innerHTML = `<p class="text-sm text-light-text-muted dark:text-dark-text-muted">${window.I18N.error_loading}</p>`;
        });
    
    // Feed View Toggle (List / Compact / Cards)
    const viewBtns = document.querySelectorAll('.feed-view-btn');
    // postsContainer already defined above (used by infinite scroll)
    const savedView = localStorage.getItem('feedView') || 'list';
    
    function setFeedView(view) {
        if (!postsContainer) return;
        postsContainer.dataset.view = view;
        localStorage.setItem('feedView', view);
        
        // Update button states
        viewBtns.forEach(btn => {
            if (btn.dataset.view === view) {
                btn.classList.add('bg-brand-teal', 'text-white');
                btn.classList.remove('text-light-text-secondary', 'dark:text-dark-text-secondary', 'hover:bg-light-bg', 'dark:hover:bg-dark-bg');
            } else {
                btn.classList.remove('bg-brand-teal', 'text-white');
                btn.classList.add('text-light-text-secondary', 'dark:text-dark-text-secondary', 'hover:bg-light-bg', 'dark:hover:bg-dark-bg');
            }
        });
        
        // Apply view styles
        const posts = postsContainer.querySelectorAll('.feed-post');
        posts.forEach(post => {
            post.classList.remove('feed-view-list', 'feed-view-compact', 'feed-view-cards');
            post.classList.add('feed-view-' + view);

            if (typeof window.refreshPostCollapse === 'function') {
                window.refreshPostCollapse(post);
            }
        });
        
        // Reinitialize image galleries for the new view
        initImageGalleries();
        
        // Adjust container layout for cards view
        if (view === 'cards') {
            postsContainer.classList.remove('space-y-6');
        } else {
            postsContainer.classList.add('space-y-6');
        }
    }
    
    // Initialize view
    setFeedView(savedView);
    
    // Add click handlers
    viewBtns.forEach(btn => {
        btn.addEventListener('click', () => setFeedView(btn.dataset.view));
    });

    // Sidebar Smart Sticky Behavior
    // This script calculates the optimal 'top' position for the sticky sidebar based on scroll direction.
    // - Scrolling Down: Sidebar slides up until its bottom sticks to the viewport bottom.
    // - Scrolling Up: Sidebar slides down until its top sticks to the viewport top (under header).
    (function() {
        const sidebar = document.getElementById('feed-sidebar');
        if (!sidebar) return;

        const mq = window.matchMedia('(min-width: 1024px)');
        const headerGap = 80; // 5rem (top-20) matches CSS top-20
        const bottomGap = 24; // 1.5rem

        let lastScrollY = window.scrollY;

        function update() {
            if (!mq.matches) {
                sidebar.style.top = '';
                return;
            }

            const sidebarHeight = sidebar.offsetHeight;
            const viewportHeight = window.innerHeight;
            
            // If sidebar is shorter than viewport (minus header), just stick to top
            if (sidebarHeight < (viewportHeight - headerGap)) {
                sidebar.style.top = `${headerGap}px`;
                return;
            }

            // Calculate sticky limits
            // minTop: sidebar bottom sticks to viewport bottom
            const minTop = viewportHeight - sidebarHeight - bottomGap;
            // maxTop: sidebar top sticks to header
            const maxTop = headerGap;

            const scrollY = window.scrollY;
            const delta = scrollY - lastScrollY;
            lastScrollY = scrollY;

            // Get current top (fallback to headerGap)
            let currentTop = parseFloat(getComputedStyle(sidebar).top);
            if (isNaN(currentTop)) currentTop = headerGap;

            // Adjust top based on scroll delta
            // If scrolling down (delta > 0), top decreases (sidebar moves up relative to viewport)
            // If scrolling up (delta < 0), top increases (sidebar moves down relative to viewport)
            let newTop = currentTop - delta;

            // Clamp between limits
            newTop = Math.min(Math.max(newTop, minTop), maxTop);

            sidebar.style.top = `${newTop}px`;
        }

        window.addEventListener('scroll', update, { passive: true });
        window.addEventListener('resize', update);
        if (mq.addEventListener) mq.addEventListener('change', update);
        
        // Watch for height changes in the sidebar (e.g. loading async content like Trending Tags)
        const resizeObserver = new ResizeObserver(() => {
            update();
        });
        resizeObserver.observe(sidebar);

        // Run once to set initial state
        update();
    })();

</script>
{{ poll_voting_js() }}
{% endblock %}
