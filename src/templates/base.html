<!DOCTYPE html>
<html lang="{{ current_lang }}" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}Chronicle{% endblock %}</title>
    <link rel="icon" href="{{ url_for('static', filename='assets/favicon.ico') }}" type="image/x-icon">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='assets/logo.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.webmanifest') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Merriweather:wght@400;700&family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        const PUSH_PUBLIC_KEY = "{{ push_public_key or '' }}";
        const IS_AUTHENTICATED = {{ 'true' if is_authenticated else 'false' }};
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').then((registration) => {
                    window.__swRegistration = registration;
                    navigator.serviceWorker.addEventListener('message', (event) => {
                        if (event.data && event.data.type === 'badge-update') {
                            window.updateAppBadges(event.data.unread_count || 0);
                        }
                    });
                    if (Notification.permission === 'granted' && IS_AUTHENTICATED && PUSH_PUBLIC_KEY) {
                        window.ensurePushSubscription?.();
                    }
                }).catch((err) => {
                    console.error('Service worker registration failed:', err);
                });
            });
        }
        window.BASE_PAGE_TITLE = document.title;
        window.updateAppBadges = function(count) {
            const safeCount = typeof count === 'number' ? count : 0;
            const clamped = safeCount > 99 ? '99+' : safeCount;
            if ('setAppBadge' in navigator) {
                if (safeCount > 0) {
                    navigator.setAppBadge(safeCount).catch(() => {});
                } else {
                    navigator.clearAppBadge().catch(() => {});
                }
            }
            document.title = safeCount > 0 ? `(${clamped}) ${window.BASE_PAGE_TITLE}` : window.BASE_PAGE_TITLE;
        };

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function sendSubscriptionToServer(subscription) {
            await fetch('/api/push/subscribe', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': window.csrfToken,
                },
                body: JSON.stringify({ subscription }),
                credentials: 'same-origin',
            });
        }

        async function removeSubscriptionFromServer(endpoint) {
            if (!endpoint) return;
            await fetch('/api/push/unsubscribe', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': window.csrfToken,
                },
                body: JSON.stringify({ endpoint }),
                credentials: 'same-origin',
            });
        }

        async function buildPushDebugSnapshot(err) {
            let swReady = null;
            let swRegistration = null;
            let swController = null;
            let pushPermissionState = null;
            let subscriptionEndpoint = null;
            try {
                if ('serviceWorker' in navigator) {
                    swReady = await navigator.serviceWorker.ready;
                    swRegistration = await navigator.serviceWorker.getRegistration('/service-worker.js');
                    swController = navigator.serviceWorker.controller ? {
                        scriptURL: navigator.serviceWorker.controller.scriptURL,
                        state: navigator.serviceWorker.controller.state,
                    } : null;
                }
            } catch (e) {
            }

            try {
                if (navigator.permissions && navigator.permissions.query) {
                    const status = await navigator.permissions.query({ name: 'push' });
                    pushPermissionState = status && status.state ? status.state : null;
                }
            } catch (e) {
            }

            try {
                if (swReady && swReady.pushManager) {
                    const sub = await swReady.pushManager.getSubscription();
                    subscriptionEndpoint = sub && sub.endpoint ? sub.endpoint : null;
                }
            } catch (e) {
            }

            const key = (PUSH_PUBLIC_KEY || '').trim();
            const keyLooksUrlSafe = /^[A-Za-z0-9_-]+$/.test(key);
            const keyLooksBase64ish = /^[A-Za-z0-9+/=_-]+$/.test(key);

            return {
                href: window.location.href,
                isSecureContext: window.isSecureContext,
                notificationPermission: (window.Notification && Notification.permission) ? Notification.permission : null,
                pushPermissionState,
                supports: {
                    serviceWorker: 'serviceWorker' in navigator,
                    pushManager: 'PushManager' in window,
                    notifications: 'Notification' in window,
                },
                vapidPublicKey: {
                    present: !!key,
                    length: key.length,
                    looksUrlSafe,
                    looksBase64ish,
                },
                serviceWorker: {
                    ready: !!swReady,
                    scope: swReady && swReady.scope ? swReady.scope : null,
                    activeState: swReady && swReady.active ? swReady.active.state : null,
                    activeScriptURL: swReady && swReady.active ? swReady.active.scriptURL : null,
                    getRegistrationScope: swRegistration && swRegistration.scope ? swRegistration.scope : null,
                    controller: swController,
                },
                existingSubscriptionEndpoint: subscriptionEndpoint,
                error: err ? {
                    name: err.name,
                    message: err.message,
                } : null,
            };
        }

        window.__buildPushDebugSnapshot = buildPushDebugSnapshot;

        window.ensurePushSubscription = async function() {
            if (!PUSH_PUBLIC_KEY || !IS_AUTHENTICATED || !('serviceWorker' in navigator) || !('PushManager' in window)) {
                return;
            }
            if (Notification.permission === 'denied') {
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.getSubscription();
                if (subscription) {
                    const endpoint = subscription.endpoint;
                    await subscription.unsubscribe();
                    await removeSubscriptionFromServer(endpoint);
                }
                return;
            }
            if (Notification.permission !== 'granted') {
                return;
            }
            try {
                const registration = await navigator.serviceWorker.ready;
                let subscription = await registration.pushManager.getSubscription();
                if (!subscription) {
                    subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(PUSH_PUBLIC_KEY),
                    });
                }
                await sendSubscriptionToServer(subscription.toJSON());
            } catch (err) {
                try {
                    const snapshot = await buildPushDebugSnapshot(err);
                    window.__lastPushDebugSnapshot = snapshot;
                    console.error('Error subscribing to push notifications', err);
                    console.error('Push subscribe debug snapshot:', snapshot);
                } catch (e) {
                    console.error('Error subscribing to push notifications', err);
                }
            }
        };

        window.requestPushPermission = function() {
            if (!IS_AUTHENTICATED || !PUSH_PUBLIC_KEY || !('Notification' in window)) {
                return;
            }
            if (Notification.permission === 'default') {
                Notification.requestPermission().then((permission) => {
                    if (permission === 'granted') {
                        window.ensurePushSubscription();
                    }
                });
            } else if (Notification.permission === 'granted') {
                window.ensurePushSubscription();
            }
        };
    </script>
    <style>
        @font-face {
            font-family: 'Ephesis';
            src: url('{{ url_for('static', filename='assets/fonts/Ephesis-Regular.ttf') }}') format('truetype');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }
        .font-logo {
            font-family: 'Ephesis', cursive;
        }
        .font-serif { font-family: 'Merriweather', Georgia, serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .font-rounded { font-family: 'Nunito', sans-serif; }
        
        /* Theme Mode CSS Variables */
        :root {
            --theme-bg: #f7faf8;
            --theme-surface: #ffffff;
            --theme-text-primary: #1f2933;
            --theme-text-secondary: #4b5563;
            --theme-text-muted: #6b7280;
            --theme-border: #e5e7eb;
        }
        html.dim {
            --theme-bg: #1a1d2e;
            --theme-surface: #242838;
            --theme-text-primary: #d4d8e0;
            --theme-text-secondary: #a0a8b8;
            --theme-text-muted: #7a8294;
            --theme-border: #363d52;
        }
        html.dark {
            --theme-bg: #0f1220;
            --theme-surface: #171a2d;
            --theme-text-primary: #e5e7eb;
            --theme-text-secondary: #b6bcc9;
            --theme-text-muted: #8b91a1;
            --theme-border: #2a2f45;
        }
        /* Dim mode styling - comprehensive overrides for all dark: variants */
        html.dim body { background-color: #1a1d2e; color: #d4d8e0; }
        html.dim .glass-header { background: rgba(26, 29, 46, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid #363d52; }
        html.dim .glass-card { background: #242838; border: 1px solid #363d52; }
        
        /* Background colors */
        html.dim .bg-light-bg, html.dim .dark\:bg-dark-bg { background-color: #1a1d2e !important; }
        html.dim .bg-light-surface, html.dim .dark\:bg-dark-surface { background-color: #242838 !important; }
        html.dim .bg-light-bg\/50, html.dim .dark\:bg-dark-bg\/50 { background-color: rgba(26, 29, 46, 0.5) !important; }
        
        /* Text colors */
        html.dim .text-light-text-primary, html.dim .dark\:text-dark-text-primary { color: #d4d8e0 !important; }
        html.dim .text-light-text-secondary, html.dim .dark\:text-dark-text-secondary { color: #a0a8b8 !important; }
        html.dim .text-light-text-muted, html.dim .dark\:text-dark-text-muted { color: #7a8294 !important; }
        
        /* Border colors */
        html.dim .border-light-border, html.dim .dark\:border-dark-border { border-color: #363d52 !important; }
        html.dim .layout-option-card { border-color: #363d52 !important; box-shadow: none !important; }
        html.dim .peer:checked + .layout-option-card { border-color: #4da9a4 !important; box-shadow: 0 0 0 1px rgba(77, 169, 164, 0.5); }
        html.dim .divide-light-border > :not([hidden]) ~ :not([hidden]) { border-color: #363d52; }
        
        /* Hover states */
        html.dim .hover\:bg-light-bg:hover, html.dim .dark\:hover\:bg-dark-bg:hover { background-color: #1a1d2e !important; }
        html.dim .hover\:bg-light-surface:hover, html.dim .dark\:hover\:bg-dark-surface:hover { background-color: #242838 !important; }
        
        /* Form elements */
        html.dim input, html.dim textarea, html.dim select { 
            background-color: #1a1d2e !important; 
            border-color: #363d52 !important; 
            color: #d4d8e0 !important; 
        }
        html.dim input::placeholder, html.dim textarea::placeholder { color: #7a8294 !important; }
        html.dim input:focus, html.dim textarea:focus, html.dim select:focus {
            border-color: #4da9a4 !important;
        }
        
        /* Toolbar and editor */
        html.dim .editor-toolbar { background-color: #1a1d2e !important; border-color: #363d52 !important; }
        html.dim .toolbar-btn { color: #a0a8b8 !important; }
        html.dim .toolbar-btn:hover { background-color: #242838 !important; }
        
        /* Poll styling */
        html.dim .poll-container { background-color: rgba(26, 29, 46, 0.5) !important; border-color: #363d52 !important; }
        html.dim .poll-option { border-color: #363d52 !important; color: #d4d8e0 !important; }
        html.dim .poll-option:hover { border-color: #4da9a4 !important; }
        html.dim .poll-percentage { color: #7a8294 !important; }
        
        /* Dropdowns and menus */
        html.dim .dropdown, html.dim [class*="dropdown"] { background-color: #242838 !important; border-color: #363d52 !important; }
        html.dim #tag-dropdown, html.dim #mention-dropdown, html.dim #lang-menu-dropdown, html.dim #notification-dropdown {
            background-color: #242838 !important; border-color: #363d52 !important;
        }
        
        /* Prose/content styling */
        html.dim .prose, html.dim .dark\:prose-invert { color: #d4d8e0 !important; }
        html.dim .prose a { color: #4da9a4; }
        html.dim .prose strong { color: #d4d8e0; }
        html.dim .prose h1, html.dim .prose h2, html.dim .prose h3, html.dim .prose h4 { color: #d4d8e0; }
        html.dim .prose code:not(.highlight code) { background: rgba(255, 255, 255, 0.1); color: #f472b6; }
        html.dim .prose pre:not(.highlight pre) { background-color: transparent; }
        html.dim .prose blockquote { border-left-color: #363d52; color: #a0a8b8; }
        
        /* Shadows and misc */
        html.dim .shadow-card { box-shadow: 0 6px 24px rgba(0,0,0,0.3); }
        html.dim .ring-light-border { --tw-ring-color: #363d52; }
        html.dim footer { background-color: #242838; border-top-color: #363d52; }
        
        /* Cover image gradient for dim mode */
        html.dim .from-light-bg, html.dim .dark\:from-dark-bg { --tw-gradient-from: #1a1d2e !important; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, transparent) !important; }
        
        /* Labels and small text */
        html.dim label { color: #a0a8b8 !important; }
        html.dim .text-sm, html.dim .text-xs { color: inherit; }
        
        /* Buttons */
        html.dim button:not(.bg-brand-teal):not(.text-brand-teal) { color: #a0a8b8; }
        html.dim .bg-light-bg\/50 { background-color: rgba(26, 29, 46, 0.5) !important; }
        
        /* Reaction tooltips - ensure they are always visible above other content */
        .reaction-tooltip { z-index: 9999 !important; }
        .reaction-badge { position: relative; overflow: visible !important; }
        .reactions-summary, .reactions-display { overflow: visible !important; }
        .post-reactions { overflow: visible !important; }
        
        /* Feed View Modes */
        .feed-view-compact { padding: 0.75rem !important; }
        .feed-view-compact .prose { font-size: 0.875rem; }
        .feed-view-compact .image-gallery[data-collapsed="true"] { max-height: 4rem !important; }
        .feed-view-compact .image-gallery[data-collapsed="false"] { max-height: none !important; }
        .feed-view-compact .link-previews { display: none; }

        #posts-container[data-view="cards"] {
            column-width: 22rem;
            column-gap: 1.75rem;
        }
        .feed-view-cards {
            display: inline-block;
            width: 100%;
            margin-bottom: 1.5rem;
            break-inside: avoid;
        }
        .feed-view-cards .image-gallery[data-collapsed="true"] { max-height: 8rem !important; }
        .feed-view-cards .image-gallery[data-collapsed="false"] { max-height: none !important; }
        @media (max-width: 1279px) {
            #view-toggle { display: none !important; }
        }
        
        /* Page Transition Animations */
        @keyframes pageSlideIn {
            from {
                opacity: 0.7;
                transform: translateY(4px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pageFadeOut {
            from { opacity: 1; }
            to { opacity: 0.5; }
        }
        
        .page-enter {
            animation: pageSlideIn 0.15s ease-out forwards;
        }
        
        .page-exit {
            animation: pageFadeOut 0.08s ease-out forwards;
        }
        
    </style>
</head>
<body class="min-h-screen flex flex-col {% if current_user.is_authenticated %}{% if current_user.font_family == 'serif' %}font-serif{% elif current_user.font_family == 'mono' %}font-mono{% elif current_user.font_family == 'rounded' %}font-rounded{% endif %}{% endif %}">
    <div id="app-content" class="min-h-screen flex flex-col page-enter">
    <header class="glass-header sticky top-0 z-50">
        <nav class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <a href="{{ url_for('index') }}" class="flex items-center gap-3">
                    <script src="{{ url_for('static', filename='js/lang.js') }}"></script>
                    <img src="{{ url_for('static', filename='assets/logo.png') }}" alt="Chronicle Logo" class="h-10 w-10 rounded-md">
                    <span class="font-logo text-3xl text-brand-teal dark:text-brand-mint">Chronicle</span>
                </a>
                <div class="flex items-center gap-2 sm:gap-4">
                    <!-- Language Selector -->
                    <div class="relative" id="lang-menu-container">
                        <button id="lang-menu-btn" class="p-2 text-light-text-secondary dark:text-dark-text-secondary hover:text-brand-teal transition-colors" title="{{ _('Language') }}">
                            <span class="text-sm font-medium uppercase">{{ current_lang }}</span>
                        </button>
                        <div id="lang-menu-dropdown" class="hidden absolute right-0 mt-2 w-32 glass-card rounded-lg shadow-xl z-50 py-1">
                            <a href="{{ url_for('set_language', lang='de') }}" class="flex items-center gap-2 px-4 py-2 text-sm {% if current_lang == 'de' %}text-brand-teal font-medium{% else %}text-light-text-secondary dark:text-dark-text-secondary{% endif %} hover:bg-light-bg dark:hover:bg-dark-bg transition-colors">
                                ðŸ‡©ðŸ‡ª Deutsch
                            </a>
                            <a href="{{ url_for('set_language', lang='en') }}" class="flex items-center gap-2 px-4 py-2 text-sm {% if current_lang == 'en' %}text-brand-teal font-medium{% else %}text-light-text-secondary dark:text-dark-text-secondary{% endif %} hover:bg-light-bg dark:hover:bg-dark-bg transition-colors">
                                ðŸ‡¬ðŸ‡§ English
                            </a>
                            <a href="{{ url_for('set_language', lang='es') }}" class="flex items-center gap-2 px-4 py-2 text-sm {% if current_lang == 'es' %}text-brand-teal font-medium{% else %}text-light-text-secondary dark:text-dark-text-secondary{% endif %} hover:bg-light-bg dark:hover:bg-dark-bg transition-colors">
                                ðŸ‡ªðŸ‡¸ EspaÃ±ol
                            </a>
                            <a href="{{ url_for('set_language', lang='fr') }}" class="flex items-center gap-2 px-4 py-2 text-sm {% if current_lang == 'fr' %}text-brand-teal font-medium{% else %}text-light-text-secondary dark:text-dark-text-secondary{% endif %} hover:bg-light-bg dark:hover:bg-dark-bg transition-colors">
                                ðŸ‡«ðŸ‡· FranÃ§ais
                            </a>
                        </div>
                    </div>
                    <!-- Theme Mode Toggle (Light/Dim/Dark) -->
                    <button id="theme-toggle" class="p-2 text-light-text-secondary dark:text-dark-text-secondary hover:text-brand-teal transition-colors" title="{{ _('Toggle theme') }}">
                        <!-- Sun icon for light mode -->
                        <svg id="theme-icon-light" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                        <!-- Half-moon icon for dim mode (first quarter moon) -->
                        <svg id="theme-icon-dim" class="w-5 h-5 hidden" fill="currentColor" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3a9 9 0 019 9 9 9 0 01-9 9 9 9 0 010-18z" fill="none"/><path d="M12 3a9 9 0 000 18V3z"/></svg>
                        <!-- Moon icon for dark mode -->
                        <svg id="theme-icon-dark" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                    </button>
                    {% if current_user.is_authenticated %}
                        <!-- Notification Bell -->
                        <div class="relative" id="notification-container">
                            <button id="notification-bell" class="p-2 text-light-text-secondary dark:text-dark-text-secondary hover:text-brand-teal transition-colors relative">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                                </svg>
                                <span id="notification-badge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
                            </button>
                            <!-- Notification Dropdown -->
                            <div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-[calc(100vw-2rem)] sm:w-80 max-w-sm max-h-96 overflow-y-auto bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded-lg shadow-xl z-50">
                                <div class="p-3 border-b border-light-border dark:border-dark-border flex justify-between items-center">
                                    <span class="font-semibold text-sm">{{ _('Notifications') }}</span>
                                    <button id="mark-all-read" class="text-xs hover:underline" style="color: {{ (current_user.theme_color or '#4da9a4') if current_user.is_authenticated else '#4da9a4' }}">{{ _('Mark all as read') }}</button>
                                </div>
                                <div id="notification-list" class="divide-y divide-light-border dark:divide-dark-border">
                                    <div class="p-4 text-center text-sm text-light-text-muted dark:text-dark-text-muted">{{ _('Loading...') }}</div>
                                </div>
                            </div>
                        </div>
                        <!-- User Menu -->
                        <div class="relative" id="user-menu-container">
                            <button id="user-menu-btn" class="flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-1.5 rounded-md text-light-text-secondary dark:text-dark-text-secondary hover:bg-light-bg dark:hover:bg-dark-bg transition-colors">
                                {% if current_user.avatar_url %}
                                <img src="{{ current_user.avatar_url }}" alt="Avatar" class="w-7 h-7 sm:w-6 sm:h-6 rounded-full object-cover">
                                {% else %}
                                <div class="w-7 h-7 sm:w-6 sm:h-6 rounded-full flex items-center justify-center text-xs font-bold text-white" style="background-color: {{ current_user.theme_color or '#4da9a4' }}">
                                    {{ (current_user.display_name or current_user.username)[0]|upper }}
                                </div>
                                {% endif %}
                                <span class="hidden sm:inline text-sm font-medium">{{ current_user.display_name or current_user.username }}</span>
                                <svg class="w-4 h-4 hidden sm:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                            <!-- User Dropdown -->
                            <div id="user-menu-dropdown" class="hidden absolute right-0 mt-2 w-48 glass-card rounded-lg shadow-xl z-50 py-1">
                                <a href="{{ url_for('blog.me') }}" class="flex items-center gap-3 px-4 py-2 text-sm text-light-text-secondary dark:text-dark-text-secondary hover:bg-light-bg dark:hover:bg-dark-bg transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                    {{ _('My Profile') }}
                                </a>
                                <a href="{{ url_for('blog.settings') }}" class="flex items-center gap-3 px-4 py-2 text-sm text-light-text-secondary dark:text-dark-text-secondary hover:bg-light-bg dark:hover:bg-dark-bg transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    </svg>
                                    {{ _('Settings') }}
                                </a>
                                <div class="border-t border-light-border dark:border-dark-border my-1"></div>
                                <a href="{{ url_for('auth.logout') }}" class="flex items-center gap-3 px-4 py-2 text-sm text-red-500 hover:bg-light-bg dark:hover:bg-dark-bg transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                    </svg>
                                    {{ _('Logout') }}
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <a href="{{ url_for('auth.login') }}" class="px-4 py-2 text-sm font-medium bg-brand-teal text-white rounded-md hover:bg-brand-blue transition-colors">
                            {{ _('Login') }}
                        </a>
                        {% if config.get('REGISTRATION_ENABLED', True) %}
                        <a href="{{ url_for('auth.register') }}" class="px-4 py-2 text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary hover:text-brand-teal transition-colors">
                            {{ _('Register') }}
                        </a>
                        {% endif %}
                    {% endif %}
                    {% block nav %}{% endblock %}
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-8 flex-grow">
        {% block content %}{% endblock %}
    </main>

    <footer class="glass-header mt-auto">
        <div class="container mx-auto px-4 py-3 text-center text-sm text-light-text-muted dark:text-dark-text-muted">
            <p>&copy; {{ current_year }} Chronicle.</p>
        </div>
    </footer>
    </div>

    <!-- Back to Top Button -->
    <button id="back-to-top" class="p-3 rounded-full bg-brand-teal text-white shadow-lg hover:shadow-xl transition-all duration-300" style="position: fixed; bottom: 5rem; right: 1.5rem; z-index: 50; opacity: 0; visibility: hidden; transform: scale(1);" title="{{ _('Back to top') }}">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
    </button>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="flash-toasts" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[60] w-[calc(100%-2rem)] max-w-md space-y-2">
                {% for category, message in messages %}
                    <div class="flash-message flex items-start justify-between gap-3 p-4 rounded-lg shadow-xl border border-light-border dark:border-dark-border bg-light-surface dark:bg-dark-surface">
                        <div class="flex items-start gap-3">
                            {% if category == 'error' %}
                                <div class="mt-0.5 w-2.5 h-2.5 rounded-full bg-red-500"></div>
                            {% elif category == 'warning' %}
                                <div class="mt-0.5 w-2.5 h-2.5 rounded-full bg-yellow-500"></div>
                            {% else %}
                                <div class="mt-0.5 w-2.5 h-2.5 rounded-full bg-green-500"></div>
                            {% endif %}
                            <div class="text-sm text-light-text-secondary dark:text-dark-text-secondary">
                                {{ message }}
                            </div>
                        </div>
                        <button type="button" class="p-1 rounded-md hover:bg-light-bg dark:hover:bg-dark-bg transition-colors" onclick="this.closest('.flash-message').remove()" title="{{ _('Close') }}">
                            <svg class="w-4 h-4 text-light-text-muted dark:text-dark-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    {% include 'components/confirm_modal.html' %}
    {% include 'components/alert_modal.html' %}
    {% include 'components/image_lightbox.html' %}

    <script>
        // Global i18n translations for JavaScript
        window.I18N = {{ js_translations|tojson|safe }};
        window.CURRENT_LANG = '{{ current_lang }}';
        
        document.addEventListener('DOMContentLoaded', function() {
            // Language menu dropdown
            const langMenuBtn = document.getElementById('lang-menu-btn');
            const langMenuDropdown = document.getElementById('lang-menu-dropdown');
            if (langMenuBtn && langMenuDropdown) {
                langMenuBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    langMenuDropdown.classList.toggle('hidden');
                });
                document.addEventListener('click', function(e) {
                    if (!langMenuDropdown.contains(e.target) && e.target !== langMenuBtn) {
                        langMenuDropdown.classList.add('hidden');
                    }
                });
            }
            
            // Flash message auto-dismiss
            const flashMessages = document.querySelectorAll('.flash-message');
            flashMessages.forEach(function(msg) {
                setTimeout(function() {
                    msg.style.transition = 'opacity 0.5s ease-out';
                    msg.style.opacity = '0';
                    setTimeout(function() {
                        msg.remove();
                    }, 500);
                }, 4000);
            });
            
            // Theme toggle (3 modes: light -> dim -> dark -> light)
            const themeToggle = document.getElementById('theme-toggle');
            const html = document.documentElement;
            const iconLight = document.getElementById('theme-icon-light');
            const iconDim = document.getElementById('theme-icon-dim');
            const iconDark = document.getElementById('theme-icon-dark');
            
            function updateThemeIcons(theme) {
                iconLight.classList.add('hidden');
                iconDim.classList.add('hidden');
                iconDark.classList.add('hidden');
                if (theme === 'light') {
                    iconLight.classList.remove('hidden');
                } else if (theme === 'dim') {
                    iconDim.classList.remove('hidden');
                } else {
                    iconDark.classList.remove('hidden');
                }
            }
            
            function setTheme(theme) {
                html.classList.remove('dark', 'dim');
                if (theme === 'dark') {
                    html.classList.add('dark');
                } else if (theme === 'dim') {
                    html.classList.add('dim');
                }
                localStorage.setItem('theme', theme);
                updateThemeIcons(theme);
            }
            
            // Check saved preference
            const savedTheme = localStorage.getItem('theme') || 'dark';
            setTheme(savedTheme);
            
            themeToggle.addEventListener('click', function() {
                let currentTheme = 'light';
                if (html.classList.contains('dark')) {
                    currentTheme = 'dark';
                } else if (html.classList.contains('dim')) {
                    currentTheme = 'dim';
                }
                // Cycle: light -> dim -> dark -> light
                const nextTheme = currentTheme === 'light' ? 'dim' : (currentTheme === 'dim' ? 'dark' : 'light');
                setTheme(nextTheme);
            });

            function initImageGalleries() {
                document.querySelectorAll('.image-gallery').forEach(function(gallery) {
                    if (gallery.dataset.initialized === 'true') return;

                    const totalImages = gallery.querySelectorAll('.group').length;
                    if (totalImages <= 3) return;

                    const isMobile = window.innerWidth < 640;
                    const imageSize = isMobile ? 102 : 136;
                    const containerWidth = gallery.offsetWidth || 300;
                    const imagesPerRow = Math.max(1, Math.floor(containerWidth / imageSize));
                    const hiddenCount = totalImages - imagesPerRow;
                    if (hiddenCount <= 0) return;

                    gallery.dataset.initialized = 'true';

                    const color = gallery.dataset.color || '#4da9a4';
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'gallery-expand-btn mt-2 text-sm font-medium transition-colors flex items-center gap-1';
                    btn.style.color = color;
                    const moreText = `${window.I18N.show_more} (${hiddenCount} ${window.I18N.more})`;
                    btn.innerHTML = `<span class="expand-text">${moreText}</span><svg class="w-4 h-4 expand-icon transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>`;

                    gallery.parentNode.appendChild(btn);

                    btn.addEventListener('click', function() {
                        const isCollapsed = gallery.dataset.collapsed === 'true';
                        const textSpan = btn.querySelector('.expand-text');
                        const icon = btn.querySelector('.expand-icon');

                        if (isCollapsed) {
                            gallery.style.maxHeight = 'none';
                            gallery.dataset.collapsed = 'false';
                            textSpan.textContent = window.I18N.show_less;
                            icon.style.transform = 'rotate(180deg)';
                        } else {
                            gallery.style.maxHeight = window.innerWidth < 640 ? '6.5rem' : '8.5rem';
                            gallery.dataset.collapsed = 'true';
                            textSpan.textContent = moreText;
                            icon.style.transform = 'rotate(0deg)';
                        }
                    });
                });
            }

            initImageGalleries();
            setTimeout(initImageGalleries, 500);
            window.addEventListener('resize', function() {
                document.querySelectorAll('.image-gallery').forEach(g => { g.dataset.initialized = 'false'; });
                document.querySelectorAll('.gallery-expand-btn').forEach(b => b.remove());
                initImageGalleries();
            });
            
            // Back to Top button
            const backToTopBtn = document.getElementById('back-to-top');
            if (backToTopBtn) {
                window.addEventListener('scroll', function() {
                    if (window.scrollY > 400) {
                        backToTopBtn.style.opacity = '1';
                        backToTopBtn.style.visibility = 'visible';
                        backToTopBtn.style.transform = 'scale(1)';
                    } else {
                        backToTopBtn.style.opacity = '0';
                        backToTopBtn.style.visibility = 'hidden';
                        backToTopBtn.style.transform = 'scale(0.8)';
                    }
                });
                backToTopBtn.addEventListener('click', function() {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
                backToTopBtn.addEventListener('mouseenter', function() {
                    backToTopBtn.style.transform = 'scale(1.1)';
                });
                backToTopBtn.addEventListener('mouseleave', function() {
                    if (window.scrollY > 400) {
                        backToTopBtn.style.transform = 'scale(1)';
                    }
                });
            }
            
            // Cover image parallax and scroll handling
            const coverContainer = document.querySelector('.cover-container');
            const coverImage = document.querySelector('.cover-image');
            
            if (coverContainer && coverImage) {
                // Scroll to top on page load
                window.scrollTo(0, 0);
                // Set CSS variable for blur color based on theme
                const updateBlurColor = () => {
                    const isDark = html.classList.contains('dark');
                    const isDim = html.classList.contains('dim');
                    let blurColor = 'rgba(247,250,248,0.6)'; // light mode default
                    if (isDark) {
                        blurColor = 'rgba(15,18,32,0.6)';
                    } else if (isDim) {
                        blurColor = 'rgba(26,29,46,0.6)'; // dim mode - matches dim bg color
                    }
                    document.documentElement.style.setProperty('--cover-blur-color', blurColor);
                };
                updateBlurColor();
                
                // Update on theme change
                const observer = new MutationObserver(updateBlurColor);
                observer.observe(html, { attributes: true, attributeFilter: ['class'] });
                
                // Track if cover is hidden
                let coverHidden = false;
                coverContainer.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
                
                window.addEventListener('scroll', function() {
                    const scrollY = window.scrollY;
                    const containerHeight = coverContainer.offsetHeight;
                    
                    // Parallax: image moves slower (0.4x speed)
                    const parallaxOffset = scrollY * 0.4;
                    coverImage.style.transform = `scale(1.1) translateY(${parallaxOffset}px)`;
                    
                    // Hide/show cover when mostly scrolled out
                    const hideThreshold = containerHeight * 1.2;
                    if (scrollY > hideThreshold && !coverHidden) {
                        coverHidden = true;
                        coverContainer.style.opacity = '0';
                        coverContainer.style.transform = 'translateY(-20px)';
                    } else if (scrollY <= hideThreshold && coverHidden) {
                        coverHidden = false;
                        coverContainer.style.opacity = '1';
                        coverContainer.style.transform = 'translateY(0)';
                    }
                }, { passive: true });
            }
            
            // Notification system
            const notificationBell = document.getElementById('notification-bell');
            const notificationDropdown = document.getElementById('notification-dropdown');
            const notificationBadge = document.getElementById('notification-badge');
            const notificationList = document.getElementById('notification-list');
            const markAllRead = document.getElementById('mark-all-read');
            
            if (notificationBell) {
                // Load notifications
                function loadNotifications() {
                    fetch('/api/notifications')
                        .then(res => res.json())
                        .then(data => {
                            // Update badge
                            if (data.unread_count > 0) {
                                notificationBadge.textContent = data.unread_count > 9 ? '9+' : data.unread_count;
                                notificationBadge.classList.remove('hidden');
                            } else {
                                notificationBadge.classList.add('hidden');
                            }
                            window.updateAppBadges(data.unread_count);
                            
                            // Render notifications
                            if (data.notifications.length === 0) {
                                notificationList.innerHTML = '<div class="p-4 text-center text-sm text-light-text-muted dark:text-dark-text-muted">Keine Benachrichtigungen</div>';
                            } else {
                                notificationList.innerHTML = data.notifications.map(n => `
                                    <a href="${n.link || '#'}" class="notification-link block p-3 hover:bg-light-bg dark:hover:bg-dark-bg transition-colors ${n.is_read ? 'opacity-60' : ''}" data-notification-id="${n.id}" data-link="${n.link || ''}">
                                        <div class="flex items-start gap-3">
                                            ${n.actor && n.actor.avatar_url ? 
                                                `<img src="${n.actor.avatar_url}" class="w-8 h-8 rounded-full object-cover flex-shrink-0">` : 
                                                `<div class="w-8 h-8 rounded-full bg-brand-teal flex items-center justify-center text-white text-xs font-bold flex-shrink-0">${n.actor ? (n.actor.display_name || n.actor.username)[0].toUpperCase() : '?'}</div>`
                                            }
                                            <div class="flex-1 min-w-0">
                                                <p class="text-sm font-medium whitespace-normal break-words">${n.title}</p>
                                                ${n.message ? `<p class="text-xs text-light-text-muted dark:text-dark-text-muted whitespace-normal break-words">${n.message}</p>` : ''}
                                                <p class="text-xs text-light-text-muted dark:text-dark-text-muted mt-1">${n.created_at}</p>
                                            </div>
                                            ${!n.is_read ? '<div class="w-2 h-2 bg-brand-teal rounded-full flex-shrink-0"></div>' : ''}
                                        </div>
                                    </a>
                                `).join('');
                                
                                // Add click handlers for notifications
                                notificationList.querySelectorAll('.notification-link').forEach(link => {
                                    link.addEventListener('click', function(e) {
                                        const notificationId = this.dataset.notificationId;
                                        const targetLink = this.dataset.link;
                                        
                                        // Mark as read
                                        fetch(`/api/notifications/${notificationId}/read`, { method: 'POST' });
                                        
                                        // Navigate to the link
                                        if (targetLink) {
                                            e.preventDefault();
                                            window.location.href = targetLink;
                                        }
                                    });
                                });
                            }
                        })
                        .catch(err => console.error('Error loading notifications:', err));
                }
                
                // Toggle dropdown
                notificationBell.addEventListener('click', function(e) {
                    e.stopPropagation();
                    notificationDropdown.classList.toggle('hidden');
                    if (!notificationDropdown.classList.contains('hidden')) {
                        loadNotifications();
                    }
                });
                
                // Close on click outside
                document.addEventListener('click', function(e) {
                    if (!notificationDropdown.contains(e.target) && e.target !== notificationBell) {
                        notificationDropdown.classList.add('hidden');
                    }
                });
                
                // Mark all as read
                markAllRead.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    fetch('/api/notifications/mark-read', { method: 'POST' })
                        .then(() => {
                            loadNotifications();
                            window.updateAppBadges(0);
                        });
                });
            }
            
            // User menu dropdown
            const userMenuBtn = document.getElementById('user-menu-btn');
            const userMenuDropdown = document.getElementById('user-menu-dropdown');
            
            if (userMenuBtn && userMenuDropdown) {
                userMenuBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    userMenuDropdown.classList.toggle('hidden');
                    // Close notification dropdown if open
                    if (notificationDropdown) {
                        notificationDropdown.classList.add('hidden');
                    }
                });
                
                document.addEventListener('click', function(e) {
                    if (!userMenuDropdown.contains(e.target) && e.target !== userMenuBtn) {
                        userMenuDropdown.classList.add('hidden');
                    }
                });
            }
            
            // Initial load for notification badge (if bell exists)
            if (notificationBell) {
                loadNotifications();
                
                // Refresh every 30 seconds
                setInterval(loadNotifications, 30000);
            }
        });
        
        // Global CSRF token for AJAX requests
        window.csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        // Override fetch to include CSRF token
        const originalFetch = window.fetch;
        window.fetch = function(url, options = {}) {
            const method = (options.method || 'GET').toUpperCase();

            if (method !== 'GET' && method !== 'HEAD' && method !== 'OPTIONS') {
                options.headers = options.headers || {};
                if (options.headers instanceof Headers) {
                    options.headers.set('X-CSRFToken', window.csrfToken);
                } else {
                    options.headers['X-CSRFToken'] = window.csrfToken;
                }

                // Ensure session cookie is included (CSRF token is tied to session)
                options.credentials = options.credentials || 'same-origin';
            }
            return originalFetch(url, options);
        };
    </script>
    {% block scripts %}{% endblock %}
    
    <!-- Page Transition Script -->
    <script>
    (function() {
        const appContent = document.getElementById('app-content');
        
        // Handle link clicks for page transitions
        document.addEventListener('click', function(e) {
            const link = e.target.closest('a');
            if (!link) return;
            
            // Skip if modifier keys, external links, hash links, or special targets
            const href = link.getAttribute('href');
            if (!href || 
                href.startsWith('#') || 
                href.startsWith('javascript:') ||
                href.startsWith('mailto:') ||
                href.startsWith('tel:') ||
                link.target === '_blank' ||
                link.hasAttribute('download') ||
                e.ctrlKey || e.metaKey || e.shiftKey ||
                link.host !== window.location.host) {
                return;
            }
            
            e.preventDefault();
            
            // Add exit animation
            appContent.classList.remove('page-enter');
            appContent.classList.add('page-exit');
            
            // Navigate immediately with minimal delay for visual feedback
            setTimeout(function() {
                window.location.href = href;
            }, 50);
        });
        
        // Handle browser back/forward
        window.addEventListener('pageshow', function(e) {
            if (e.persisted) {
                // Page was restored from cache
                appContent.classList.remove('page-exit');
                appContent.classList.add('page-enter');
            }
        });
    })();
    </script>
    
    
    <!-- Social Media Embed Scripts -->
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <script async src="//www.instagram.com/embed.js"></script>
</body>
</html>

