{% extends 'base.html' %}

{% block title %}{% if announcement %}{{ _('Edit announcement') }}{% else %}{{ _('New announcement') }}{% endif %} - {{ group.name }} - Chronicle{% endblock %}

{% block content %}
<div class="container mx-auto px-4 max-w-2xl">
    <!-- Header -->
    <div class="flex items-center gap-3 mb-6">
        <a href="{{ url_for('social.group_detail', slug=group.slug) }}" class="p-2 text-light-text-secondary dark:text-dark-text-secondary hover:text-brand-teal rounded-lg hover:bg-light-bg dark:hover:bg-dark-bg transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
        </a>
        <div>
            <h1 class="text-xl font-bold text-light-text dark:text-dark-text">
                {% if announcement %}{{ _('Edit announcement') }}{% else %}{{ _('New announcement') }}{% endif %}
            </h1>
            <p class="text-sm text-light-text-muted dark:text-dark-text-muted">{{ group.name }}</p>
        </div>
    </div>

    <!-- Form -->
    <form method="POST" class="glass-card p-6 rounded-xl space-y-5">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <!-- Content -->
        <div>
            <label for="content" class="block text-sm font-medium text-light-text dark:text-dark-text mb-2">
                {{ _('Content') }} (Markdown)
            </label>
            <textarea 
                id="content" 
                name="content" 
                rows="6" 
                class="w-full px-4 py-3 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg text-light-text dark:text-dark-text placeholder-light-text-muted dark:placeholder-dark-text-muted focus:ring-2 focus:ring-brand-teal focus:border-transparent transition-all resize-y"
                placeholder="{{ _('Write your announcement... (Markdown is supported)') }}"
                required
            >{{ announcement.content if announcement else '' }}</textarea>
            <p class="mt-1 text-xs text-light-text-muted dark:text-dark-text-muted">
                {{ _('Markdown is supported: **bold**, *italic*, [links](url), lists, etc.') }}
            </p>
        </div>

        <!-- Border Color -->
        <div>
            <label for="border_color" class="block text-sm font-medium text-light-text dark:text-dark-text mb-2">
                {{ _('Border color') }}
            </label>
            <div class="flex items-center gap-3">
                <input 
                    type="color" 
                    id="border_color" 
                    name="border_color" 
                    value="{{ announcement.border_color if announcement else '#f59e0b' }}"
                    class="w-12 h-10 rounded-lg border border-light-border dark:border-dark-border cursor-pointer"
                >
                <div class="flex gap-2">
                    {% set preset_colors = ['#f59e0b', '#ef4444', '#22c55e', '#3b82f6', '#8b5cf6', '#ec4899', '#4da9a4'] %}
                    {% for color in preset_colors %}
                    <button type="button" 
                        onclick="document.getElementById('border_color').value = '{{ color }}'; updatePreview();"
                        class="w-8 h-8 rounded-full border-2 border-white/20 hover:scale-110 transition-transform"
                        style="background-color: {{ color }};"
                        title="{{ color }}">
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Preview -->
        <div>
            <label class="block text-sm font-medium text-light-text dark:text-dark-text mb-2">
                {{ _('Preview') }}
            </label>
            <div id="preview-card" class="glass-card p-4 rounded-xl relative overflow-hidden" style="border-left: 4px solid {{ announcement.border_color if announcement else '#f59e0b' }};">
                <div class="flex items-center gap-2 mb-3">
                    <div id="preview-icon-bg" class="p-1.5 rounded-lg" style="background-color: {{ (announcement.border_color if announcement else '#f59e0b') }}20;">
                        <svg id="preview-icon" class="w-4 h-4" style="color: {{ announcement.border_color if announcement else '#f59e0b' }};" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/>
                        </svg>
                    </div>
                    <span class="text-xs font-medium text-light-text-muted dark:text-dark-text-muted uppercase tracking-wide">{{ _('Announcement') }}</span>
                </div>
                <div id="preview-content" class="prose prose-sm dark:prose-invert max-w-none text-light-text dark:text-dark-text">
                    <p class="text-light-text-muted dark:text-dark-text-muted italic">{{ _('Preview appears here...') }}</p>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-end gap-3 pt-2">
            <a href="{{ url_for('social.group_detail', slug=group.slug) }}" class="px-4 py-2 text-sm text-light-text-secondary dark:text-dark-text-secondary hover:text-light-text dark:hover:text-dark-text transition-colors">
                {{ _('Cancel') }}
            </a>
            <button type="submit" class="btn-primary px-5 py-2 text-sm rounded-lg">
                {% if announcement %}{{ _('Save') }}{% else %}{{ _('Create') }}{% endif %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    const contentInput = document.getElementById('content');
    const colorInput = document.getElementById('border_color');
    const previewCard = document.getElementById('preview-card');
    const previewIconBg = document.getElementById('preview-icon-bg');
    const previewIcon = document.getElementById('preview-icon');
    const previewContent = document.getElementById('preview-content');

    function updatePreview() {
        const color = colorInput.value;
        previewCard.style.borderLeftColor = color;
        previewIconBg.style.backgroundColor = color + '20';
        previewIcon.style.color = color;
        
        const content = contentInput.value.trim();
        if (content) {
            // Use server-side markdown rendering for accurate preview
            fetch('/api/render-markdown', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify({ content: content })
            })
            .then(res => res.json())
            .then(data => {
                previewContent.innerHTML = data.html || '<p class="text-light-text-muted dark:text-dark-text-muted italic">' + window.I18N.preview_appears_here + '</p>';
            })
            .catch(() => {
                // Fallback to basic markdown if API fails
                let html = content
                    .replace(/^### (.+)$/gm, '<h3 class="text-base font-semibold">$1</h3>')
                    .replace(/^## (.+)$/gm, '<h2 class="text-lg font-semibold">$1</h2>')
                    .replace(/^# (.+)$/gm, '<h1 class="text-xl font-bold">$1</h1>')
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.+?)\*/g, '<em>$1</em>')
                    .replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" class="text-brand-teal hover:underline">$1</a>')
                    .replace(/\n/g, '<br>');
                previewContent.innerHTML = html;
            });
        } else {
            previewContent.innerHTML = '<p class="text-light-text-muted dark:text-dark-text-muted italic">' + window.I18N.preview_appears_here + '</p>';
        }
    }
    
    // Debounce preview updates
    let previewTimeout;
    function debouncedUpdatePreview() {
        clearTimeout(previewTimeout);
        // Update color immediately
        const color = colorInput.value;
        previewCard.style.borderLeftColor = color;
        previewIconBg.style.backgroundColor = color + '20';
        previewIcon.style.color = color;
        // Debounce content rendering
        previewTimeout = setTimeout(updatePreview, 300);
    }

    contentInput.addEventListener('input', debouncedUpdatePreview);
    colorInput.addEventListener('input', debouncedUpdatePreview);
    
    // Initial preview
    updatePreview();
</script>
{% endblock %}
