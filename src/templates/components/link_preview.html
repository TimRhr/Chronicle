<!-- Link Preview Component -->
{% macro render_link_preview(preview) %}
{% if preview.embed_type == 'youtube' %}
<div class="youtube-preview my-4 relative aspect-video rounded-lg overflow-hidden shadow-md cursor-pointer group" data-video-id="{{ preview.embed_id }}">
    <img src="https://img.youtube.com/vi/{{ preview.embed_id }}/maxresdefault.jpg" 
         alt="{{ preview.title or 'YouTube Video' }}" 
         class="w-full h-full object-cover"
         onerror="this.src='https://img.youtube.com/vi/{{ preview.embed_id }}/hqdefault.jpg'">
    <div class="absolute inset-0 bg-black/30 group-hover:bg-black/40 transition-colors flex items-center justify-center">
        <div class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform shadow-lg">
            <svg class="w-8 h-8 text-white ml-1" fill="currentColor" viewBox="0 0 24 24">
                <path d="M8 5v14l11-7z"/>
            </svg>
        </div>
    </div>
    {% if preview.title %}
    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-3">
        <p class="text-white text-sm font-medium line-clamp-2">{{ preview.title }}</p>
        <p class="text-white/70 text-xs mt-1">YouTube</p>
    </div>
    {% endif %}
</div>

{% elif preview.embed_type == 'vimeo' %}
<div class="embed-container my-4 aspect-video rounded-lg overflow-hidden shadow-md">
    <iframe src="https://player.vimeo.com/video/{{ preview.embed_id }}" 
            class="w-full h-full" 
            frameborder="0" 
            allow="autoplay; fullscreen; picture-in-picture" 
            allowfullscreen></iframe>
</div>

{% elif preview.embed_type == 'spotify' %}
<div class="embed-container my-4 rounded-lg overflow-hidden shadow-md">
    <iframe src="https://open.spotify.com/embed/{{ preview.embed_id }}" 
            class="w-full" 
            height="152" 
            frameborder="0" 
            allow="encrypted-media"></iframe>
</div>

{% elif preview.embed_type == 'twitter' %}
<div class="embed-container twitter-embed my-4" data-tweet-id="{{ preview.embed_id }}">
    <blockquote class="twitter-tweet" data-dnt="true">
        <a href="https://twitter.com/x/status/{{ preview.embed_id }}">Tweet laden...</a>
    </blockquote>
</div>

{% elif preview.embed_type == 'instagram' %}
<div class="embed-container instagram-embed my-4" data-instagram-id="{{ preview.embed_id }}">
    <blockquote class="instagram-media" data-instgrm-permalink="https://www.instagram.com/p/{{ preview.embed_id }}/" data-instgrm-version="14">
        <a href="https://www.instagram.com/p/{{ preview.embed_id }}/" target="_blank">Instagram Post ansehen</a>
    </blockquote>
</div>

{% elif preview.embed_type == 'link' and (preview.title or preview.description) %}
<a href="{{ preview.url }}" target="_blank" rel="noopener noreferrer" class="block my-4 no-underline group">
    <div class="flex bg-light-bg dark:bg-dark-bg border border-light-border dark:border-dark-border rounded-lg overflow-hidden hover:border-brand-teal transition-colors">
        {% if preview.image_url %}
        <div class="flex-shrink-0 w-32 h-32 md:w-40 md:h-28">
            <img src="{{ preview.image_url }}" alt="" class="w-full h-full object-cover" loading="lazy" onerror="this.parentElement.style.display='none'">
        </div>
        {% endif %}
        <div class="flex-1 p-3 min-w-0">
            {% if preview.site_name %}
            <p class="text-xs text-light-text-muted dark:text-dark-text-muted uppercase tracking-wide mb-1">{{ preview.site_name }}</p>
            {% endif %}
            {% if preview.title %}
            <h4 class="font-medium text-light-text-primary dark:text-dark-text-primary group-hover:text-brand-teal transition-colors line-clamp-2 mb-1">{{ preview.title }}</h4>
            {% endif %}
            {% if preview.description %}
            <p class="text-sm text-light-text-secondary dark:text-dark-text-secondary line-clamp-2">{{ preview.description }}</p>
            {% endif %}
        </div>
    </div>
</a>
{% endif %}
{% endmacro %}

{% macro render_all_previews(previews) %}
{% for preview in previews %}
    {{ render_link_preview(preview) }}
{% endfor %}
{% endmacro %}

<!-- YouTube click-to-play script (add to page) -->
{% macro youtube_script() %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.youtube-preview').forEach(function(preview) {
        preview.addEventListener('click', function() {
            const videoId = this.dataset.videoId;
            const iframe = document.createElement('iframe');
            iframe.src = 'https://www.youtube.com/embed/' + videoId + '?autoplay=1&rel=0';
            iframe.className = 'w-full h-full absolute inset-0';
            iframe.frameBorder = '0';
            iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
            iframe.allowFullscreen = true;
            
            this.innerHTML = '';
            this.appendChild(iframe);
            this.classList.remove('cursor-pointer');
        });
    });
});
</script>
{% endmacro %}

