{% extends "base.html" %}
{% from "components/link_preview.html" import render_link_preview, render_all_previews %}
{% from "components/post_interactions.html" import reactions_bar %}
{% from "components/reactions_js.html" import reactions_scripts %}

{% block title %}{{ page.title }} - {{ profile_user.display_name or profile_user.username }} - Chronicle{% endblock %}

{% block content %}
<!-- Cover Image with Parallax -->
{% if profile_user.cover_image_url %}
<div class="relative h-56 md:h-72 -mx-4 md:-mx-8 -mt-4 mb-6 cover-container">
    <div class="absolute inset-x-4 inset-y-2 rounded-2xl overflow-hidden shadow-lg cover-frame" style="border-radius: 1rem;">
        <img src="{{ profile_user.cover_image_url }}" alt="Cover" class="w-full h-full object-cover cover-image scale-110" style="border-radius: 1rem;">
    </div>
    <div class="absolute inset-x-4 inset-y-2 rounded-2xl pointer-events-none" style="box-shadow: inset 0 0 30px 10px var(--cover-blur-color, rgba(247,250,248,0.5));"></div>
    <div class="absolute inset-x-4 bottom-2 h-20 bg-gradient-to-t from-light-bg dark:from-dark-bg to-transparent rounded-b-2xl"></div>
</div>
{% endif %}

<div class="max-w-3xl mx-auto">
    <!-- Profile Header -->
    <div class="glass-card p-6 mb-6 {% if profile_user.cover_image_url %}-mt-32 relative z-10{% endif %}">
        <div class="flex items-start gap-4">
            <a href="{{ url_for('blog.public_profile', username=profile_user.username) }}" class="flex-shrink-0">
                {% if profile_user.avatar_url %}
                <img src="{{ profile_user.avatar_url }}" alt="Avatar" class="w-20 h-20 rounded-full object-cover border-2 hover:opacity-80 transition-opacity" style="border-color: {{ profile_user.theme_color or '#4da9a4' }}">
                {% else %}
                <div class="w-16 h-16 rounded-full flex items-center justify-center text-xl font-bold text-white hover:opacity-80 transition-opacity" style="background-color: {{ profile_user.theme_color or '#4da9a4' }}">
                    {{ (profile_user.display_name or profile_user.username)[0]|upper }}
                </div>
                {% endif %}
            </a>
            <div class="flex-1 min-w-0">
                <a href="{{ url_for('blog.public_profile', username=profile_user.username) }}" class="font-heading text-lg font-bold hover:underline">{{ profile_user.display_name or profile_user.username }}</a>
                <p class="text-sm text-light-text-muted dark:text-dark-text-muted">@{{ profile_user.username }}</p>
                {% if page.description %}
                <p class="text-sm text-light-text-secondary dark:text-dark-text-secondary mt-1">{{ page.description }}</p>
                {% endif %}
            </div>
        </div>
        
        {% if pages %}
        <div class="mt-4 pt-4 border-t border-light-border dark:border-dark-border">
            <div class="flex flex-wrap gap-2">
                <a href="{{ url_for('blog.public_profile', username=profile_user.username) }}" class="px-3 py-1 text-sm rounded-full border border-light-border dark:border-dark-border hover:bg-light-bg dark:hover:bg-dark-bg transition-colors">
                    Ãœbersicht
                </a>
                {% for p in pages %}
                <a href="{{ url_for('blog.public_profile_page', username=profile_user.username, slug=p.slug) }}" class="px-3 py-1 text-sm rounded-full border transition-colors {% if p.id == page.id %}text-white{% else %}border-light-border dark:border-dark-border hover:bg-light-bg dark:hover:bg-dark-bg{% endif %}" {% if p.id == page.id %}style="background-color: {{ profile_user.theme_color or '#4da9a4' }}; border-color: {{ profile_user.theme_color or '#4da9a4' }}"{% endif %}>
                    {{ p.title }}
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Posts -->
    {% if posts %}
    <div id="posts-container" class="space-y-6">
        {% for post in posts %}
        <article class="glass-card p-6">
            {% if post.title %}
            <h2 class="font-heading text-lg font-bold mb-2">{{ post.title }}</h2>
            {% endif %}
            
            <p class="text-xs text-light-text-muted dark:text-dark-text-muted mb-3">
                {{ (post.scheduled_at or post.published_at or post.created_at)|format_dt }}
            </p>
            
            {% if post.content %}
            <div class="prose dark:prose-invert max-w-none text-light-text-secondary dark:text-dark-text-secondary">
                {{ post.content|markdown|safe }}
            </div>
            {% endif %}
            
            {% if post.link_previews.count() > 0 %}
            <div class="link-previews mt-4">
                {{ render_all_previews(post.link_previews) }}
            </div>
            {% endif %}
            
            {% if post.media_items.all()|length > 0 %}
            <div class="mt-4">
                <div class="image-gallery flex flex-wrap gap-2 overflow-hidden transition-all duration-300 ease-in-out" style="max-height: 8.5rem;" data-collapsed="true" data-color="{{ profile_user.theme_color or '#4da9a4' }}">
                    {% for media in post.media_items.order_by('order').all() %}
                    <div class="group relative">
                        <img src="{{ url_for('static', filename=media.file_path) }}" alt="{{ media.alt_text or 'Bild' }}" class="lightbox-image h-32 w-32 object-cover rounded-md cursor-pointer">
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            {% if post.tags %}
            <div class="mt-3 flex flex-wrap gap-1">
                {% for tag in post.tags %}
                <a href="{{ url_for('blog.feed', tag=tag.slug) }}" class="text-xs px-2 py-1 rounded-full hover:opacity-80 transition-opacity" style="background-color: {{ (tag.color or '#4da9a4') }}20; color: {{ tag.color or '#4da9a4' }}">
                    #{{ tag.name }}
                </a>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Reactions & Comments -->
            {{ reactions_bar(post, profile_user.theme_color, is_own_profile) }}
            
            <!-- Comments Section -->
            <div class="comments-section hidden mt-4 pt-4 border-t border-light-border dark:border-dark-border">
                <div class="comments-list space-y-3 mb-4"></div>
                {% if current_user.is_authenticated %}
                <form class="comment-form flex gap-2">
                    <input type="text" class="comment-input flex-1 px-3 py-2 text-sm border border-light-border dark:border-dark-border rounded-md bg-light-bg dark:bg-dark-bg focus:outline-none focus:ring-2 focus:ring-brand-teal" placeholder="{{ _('Write a comment...') }}">
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white rounded-md transition-colors" style="background-color: {{ profile_user.theme_color or '#4da9a4' }}">
                        {{ _('Send') }}
                    </button>
                </form>
                {% else %}
                <p class="text-sm text-light-text-muted dark:text-dark-text-muted">
                    <a href="{{ url_for('auth.login') }}" class="text-brand-teal hover:underline">{{ _('Login') }}</a>, {{ _('to comment.') }}
                </p>
                {% endif %}
            </div>
        </article>
        {% endfor %}
    </div>

    <!-- Infinite Scroll Trigger -->
    {% if has_more %}
    <div id="infinite-scroll-trigger" class="mt-6 py-4" data-page="{{ current_page + 1 }}">
        <div id="loading-indicator" class="hidden">
            <div class="glass-card p-6 animate-pulse">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 bg-light-border dark:bg-dark-border rounded-full"></div>
                    <div class="flex-1">
                        <div class="h-4 bg-light-border dark:bg-dark-border rounded w-32 mb-2"></div>
                        <div class="h-3 bg-light-border dark:bg-dark-border rounded w-48"></div>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="h-4 bg-light-border dark:bg-dark-border rounded w-full"></div>
                    <div class="h-4 bg-light-border dark:bg-dark-border rounded w-5/6"></div>
                    <div class="h-4 bg-light-border dark:bg-dark-border rounded w-4/6"></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div id="end-of-posts" class="hidden mt-6 text-center text-sm text-light-text-muted dark:text-dark-text-muted">
        {{ _('No more posts') }}
    </div>
    {% else %}
    <div class="glass-card p-12 text-center">
        <svg class="w-16 h-16 mx-auto mb-4 text-light-text-muted dark:text-dark-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
        <h3 class="font-heading text-lg font-bold mb-2">{{ _('No posts on this page') }}</h3>
        <p class="text-light-text-muted dark:text-dark-text-muted">{{ _('No posts have been published on this page yet.') }}</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ reactions_scripts(profile_user.theme_color, current_user.id if current_user.is_authenticated else None) }}

<script>
    // Infinite Scroll (public profile page)
    const postsContainer = document.getElementById('posts-container');
    let isLoading = false;
    let hasMore = {{ 'true' if has_more else 'false' }};
    const username = '{{ profile_user.username }}';
    const pageSlug = '{{ page.slug }}';

    function loadMorePosts() {
        if (isLoading || !hasMore || !postsContainer) return;

        const trigger = document.getElementById('infinite-scroll-trigger');
        if (!trigger) return;

        const loadingIndicator = document.getElementById('loading-indicator');
        const nextPage = parseInt(trigger.dataset.page);

        isLoading = true;
        if (loadingIndicator) loadingIndicator.classList.remove('hidden');

        fetch('/u/' + encodeURIComponent(username) + '/page/' + encodeURIComponent(pageSlug) + '/api?page=' + nextPage)
            .then(res => res.json())
            .then(data => {
                const html = (data && data.html) ? data.html : '';
                if (html) {
                    const wrapper = document.createElement('div');
                    wrapper.innerHTML = html;
                    const newArticles = Array.from(wrapper.querySelectorAll('article'));
                    newArticles.forEach(a => postsContainer.appendChild(a));

                    setTimeout(() => {
                        if (typeof window.initArticleInteractions === 'function') {
                            newArticles.forEach(a => window.initArticleInteractions(a));
                        }
                        if (typeof window.refreshPostCollapse === 'function') {
                            newArticles.forEach(a => window.refreshPostCollapse(a));
                        }
                    }, 100);
                }

                hasMore = !!(data && data.has_more);
                if (hasMore) {
                    trigger.dataset.page = String((data && data.page ? data.page : nextPage) + 1);
                } else {
                    trigger.remove();
                    const endEl = document.getElementById('end-of-posts');
                    if (endEl) endEl.classList.remove('hidden');
                }
            })
            .catch(err => {
                console.error('Error loading posts:', err);
            })
            .finally(() => {
                isLoading = false;
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
            });
    }

    const scrollTrigger = document.getElementById('infinite-scroll-trigger');
    if (scrollTrigger) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    loadMorePosts();
                }
            });
        }, { rootMargin: '200px' });

        observer.observe(scrollTrigger);
    }
</script>
{% endblock %}

